<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>みんなでブラケット診断</title>

<link rel="preconnect" href="https://esm.sh" crossorigin>
<link rel="preconnect" href="https://www.hareruyamtg.com" crossorigin>
<link rel="dns-prefetch" href="//www.hareruyamtg.com">

<style>
:root{
  --bg:#fff; --fg:#111; --muted:#6b7280; --card:#fff; --border:#e5e7eb;
  --brand:#d62828; --c1:#6EE7B7; --c2:#4E9CFF; --c3:#FFC857; --c4:#FF6B6B;
  --radius:14px; --primary:#ef4444; --primary-weak:#fde8e8;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:"Inter","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--fg);background:var(--bg)}
.wrap{max-width:1200px;margin:0 auto;padding:16px}

header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0 12px}
.title{display:flex;flex-direction:column;gap:4px;min-width:0}
.site{font-weight:800;letter-spacing:.01em;font-size:20px}
@media(min-width:1000px){ .site{font-size:24px} }
.deck-meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px}
.deck-link{color:#2563eb;text-decoration:underline;text-underline-offset:2px}

.small-btn{font-size:13px;border:1px solid var(--border);background:#fff;color:#374151;border-radius:999px;padding:6px 12px;cursor:pointer}
.small-btn:hover{background:#fafafa}
.small-btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
.small-btn.primary.ghost{background:var(--primary-weak);color:#b91c1c;border-color:#fecaca}

.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.grid{display:grid;gap:16px}
@media(min-width:1000px){ .grid{grid-template-columns:1.2fr .8fr} }

/* 埋め込み */
.embed-wrap{position:relative;background:#fff;border-radius:var(--radius);overflow:hidden;border:1px solid var(--border)}
iframe{width:100%;height:70vh;min-height:520px;border:0;display:block;background:#fff}
.overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(0deg, rgba(255,255,255,.94), rgba(255,255,255,.94));text-align:center;padding:18px}
.overlay .box{max-width:560px}
.overlay .box h3{margin:0 0 8px;font-size:18px}
.overlay .box p{margin:6px 0;color:#4b5563;font-size:14px}
.overlay .box .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
.overlay .box a, .overlay .box button{border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:#fff;cursor:pointer;font-size:14px}

/* 投票パネル */
.vote-card{display:flex;flex-direction:column;gap:12px}
.vote-block{padding:12px;border:1px dashed var(--border);border-radius:14px;background:#fafafa}
.prompt{font-weight:800;letter-spacing:.01em;font-size:16px}
@media(min-width:1000px){ .prompt{font-size:20px} }

/* ボタン：スマホ2列 / 大画面4列 */
.vote-row{display:grid; gap:10px; grid-template-columns:1fr 1fr; margin-top:10px}
@media(min-width:1000px){ .vote-row{grid-template-columns:repeat(4,1fr)} }
.chip{
  width:100%; height:64px; font-size:22px; font-weight:800;
  border:1px solid var(--border); border-radius:12px; background:#f4f4f5;
  cursor:pointer; transition:transform .07s ease, background .15s ease, box-shadow .15s ease;
}
.chip:hover{background:#e9e9eb}
.chip:active{transform:scale(.98)}
.b1{background:color-mix(in srgb, var(--c1) 18%, white)}
.b2{background:color-mix(in srgb, var(--c2) 16%, white)}
.b3{background:color-mix(in srgb, var(--c3) 20%, white)}
.b4{background:color-mix(in srgb, var(--c4) 20%, white)}
@media(min-width:1000px){ .chip{height:72px; font-size:24px} }

/* 選択中の見た目（明るく）＆連打ガード */
.chip.selected{
  position:relative; outline:2px solid var(--brand);
  box-shadow:0 0 0 4px color-mix(in srgb, var(--brand) 18%, transparent) inset;
  transform: translateY(-1px); filter:brightness(1.03)
}
.chip[disabled]{opacity:.6; pointer-events:none; filter:grayscale(.2)}

.skip-row{margin-top:6px}
.skip{font-size:12px;color:#6b7280;text-decoration:underline;background:transparent;border:0;cursor:pointer}

/* 集計バー */
.results{display:none;flex-direction:column;gap:8px}
.bar{position:relative;height:30px;border-radius:8px;background:#f3f4f6;border:1px solid #e5e7eb;overflow:hidden}
.seg{position:absolute;top:0;bottom:0}
.seg.b1{background:var(--c1)} .seg.b2{background:var(--c2)} .seg.b3{background:var(--c3)} .seg.b4{background:var(--c4)}
.legend{display:flex;gap:10px;flex-wrap:wrap;color:#374151;font-size:13px}
.legend span{display:inline-flex;align-items:center;gap:6px}
.dot{width:12px;height:12px;border-radius:999px;display:inline-block}
.hint{font-size:12px;color:var(--muted)}

/* 右シート */
.sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none}
.sheet{position:fixed;right:0;top:0;bottom:0;width:min(520px,100%);background:#fff;box-shadow:-10px 0 30px rgba(0,0,0,.2);display:none;flex-direction:column}
.sheet header{padding:16px;border-bottom:1px solid var(--border)}
.sheet .body{padding:16px;display:flex;flex-direction:column;gap:12px;overflow:auto;max-height:calc(100vh - 56px)}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:13px}
.tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
.note{font-size:12px;color:var(--muted);line-height:1.6}
.msg{font-size:14px}
.item{display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:10px;padding:8px}
.item a{color:#111;text-decoration:none}
.item a:hover{text-decoration:underline}

.subtle{opacity:.6; font-size:12px}
.subtle:hover{opacity:.8}

.search-card{display:flex;flex-direction:column;gap:12px}
.search-row{display:flex;gap:8px;flex-wrap:nowrap}
input[type="text"]{flex:1 1 420px; min-width:260px; padding:14px 16px; border:1px solid var(--border); border-radius:10px; font-size:15px}

/* トースト */
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;display:none}

/* Mana/XP バー（控えめ・灰色・短い） */
.mana-wrap{display:flex;align-items:center;gap:6px;margin-top:6px}
.mana-bar{
  width:88px; height:4px;
  background:#f3f4f6; border:1px solid #e5e7eb; border-radius:999px; overflow:hidden
}
.mana-bar > i{display:block;height:100%;width:0;background:#cbd5e1}
.mana-label{font-size:12px;color:var(--muted)}
.mana-syms{display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.sym{width:16px;height:16px;border-radius:999px;border:1px solid #e5e7eb;display:inline-flex;align-items:center;justify-content:center;font-size:11px;line-height:1;background:#fff}
.sym.W{background:#fefce8;border-color:#fde68a}
.sym.U{background:#eff6ff;border-color:#bfdbfe}
.sym.B{background:#f5f5f5;border-color:#d4d4d4}
.sym.R{background:#fee2e2;border-color:#fecaca}
.sym.G{background:#ecfdf5;border-color:#bbf7d0}
.sym.C{background:#f3f4f6;border-color:#e5e7eb}
.rt{font-size:12px;color:#9ca3af;margin-left:6px}

/* ▼ Xボタン（黒地・白字）とアイコン（公式SVGをimgで表示） */
.btn-icon{display:inline-flex;align-items:center;gap:6px}
.btn-icon svg,
.btn-icon img{width:14px;height:14px;display:block}

.btn-x{
  background:#000 !important;
  border-color:#000 !important;
  color:#fff !important;
}
.btn-x:hover{ background:#111 !important }

/* 削除希望は薄色をやめて通常色に */
#reportBtn{ color:#111 !important; opacity:1 !important }

</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <a href="./" class="site" style="color:inherit;text-decoration:none">みんなでブラケット診断</a>
      <div class="deck-meta">
        <a class="deck-link" data-deck-title target="_blank" rel="noopener">Hareruya Deck</a>
        <span data-deck-date style="display:none">0000/00/00</span>
      </div>
    </div>
    <button id="openSheet" class="small-btn">登録 / 削除</button>
  </header>

  <div class="grid">
    <div class="embed-wrap card">
      <iframe id="deckFrame" title="Hareruya Deck"
              sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation-by-user-activation"
              loading="eager"></iframe>

      <div class="overlay" id="embedFail">
        <div class="box">
          <h3>ページを表示できませんでした</h3>
          <p>ブラウザや拡張機能の制限で埋め込みがブロックされる場合があります。下のリンクから新しいタブで開いてください。</p>
          <div class="row">
            <a id="openHareruyaLink" target="_blank" rel="noopener noreferrer">hareruyamtg.com で開く</a>
            <button id="retryEmbed">再読み込み</button>
          </div>
          <p class="note" style="margin-top:10px">※ iOS/Safariの場合、トラッキング防止/コンテンツブロッカー設定により表示されないことがあります。</p>
        </div>
      </div>
    </div>

    <div class="card vote-card">
      <div class="vote-block">
        <div class="prompt">このデッキのブラケットは？</div>
        <div class="vote-row">
          <button class="chip b1" data-vote="1">１</button>
          <button class="chip b2" data-vote="2">２</button>
          <button class="chip b3" data-vote="3">３</button>
          <button class="chip b4" data-vote="4">４</button>
        </div>
        <div class="skip-row">
          <button class="skip" id="skipBtn" title="このデッキは評価しない">回答しない</button>
        </div>
        <div class="hint">※ 同じデッキは1つだけ記録（あとから変更できます）</div>
      </div>

      <div class="results" id="results">
        <div class="bar" aria-label="集計バー">
          <div class="seg b1" id="seg1" style="left:0;width:0%"></div>
          <div class="seg b2" id="seg2" style="left:0;width:0%"></div>
          <div class="seg b3" id="seg3" style="left:0;width:0%"></div>
          <div class="seg b4" id="seg4" style="left:0;width:0%"></div>
        </div>
        <div class="legend">
          <span><i class="dot" style="background:var(--c1)"></i> 1 <b id="p1">0%</b></span>
          <span><i class="dot" style="background:var(--c2)"></i> 2 <b id="p2">0%</b></span>
          <span><i class="dot" style="background:var(--c3)"></i> 3 <b id="p3">0%</b></span>
          <span><i class="dot" style="background:var(--c4)"></i> 4 <b id="p4">0%</b></span>
        </div>

        <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
          <button id="nextBtn" class="small-btn primary">▶ 次のデッキへ</button>
          <span class="hint" id="autoNextHint"></span>
          <span class="right"></span>
        </div>
      </div>

      <!-- 常時表示の操作ボタン -->
<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
  <!-- 公式の X アイコン（Simple Icons CDN）を白で表示 -->
  <button id="shareBtn" class="small-btn btn-icon btn-x" aria-label="Xでシェア">
    <img src="https://cdn.simpleicons.org/x/FFFFFF" alt="" loading="lazy" decoding="async">
    Xでシェア
  </button>

  <!-- 削除希望は通常の文字色（薄色クラスは使わない） -->
  <button id="reportBtn" class="small-btn">削除希望</button>
</div>

      <!-- Mana/XP（控えめ） -->
      <div class="mana-wrap">
        <span class="mana-label"><span id="manaLv">0</span> Mana</span>
        <div class="mana-bar"><i id="manaFill" style="width:0%"></i></div>
        <span class="rt" id="rtLabel" style="display:none">0sec</span>
      </div>
      <div class="mana-syms" id="manaSyms"></div>
    </div>
  </div>

  <div class="card search-card" style="margin-top:16px">
    <div class="search-row">
      <input type="text" id="searchInput" placeholder="例: https://www.hareruyamtg.com/decks/0000000  または 0000000">
      <button id="searchBtn" class="small-btn">検索</button>
    </div>
  </div>

  <!-- リーガル -->
  <footer class="card" style="margin-top:16px">
    <div class="note">
      ※ 本サイトは外部サイトのページを埋め込み表示します。掲載URLはユーザー投稿であり、
      内容の正確性・合法性を保証しません。著作権等の権利は各権利者に帰属します。
      不適切・権利侵害の疑いがあるURLは「削除希望」からご連絡ください。必要に応じて削除対応します。
    </div>
  </footer>
</div>

<!-- 右シート -->
<div class="sheet-backdrop" id="backdrop"></div>
<aside class="sheet" id="sheet">
  <header>
    <div style="font-weight:700">登録 / 削除</div>
    <button id="closeSheet" class="small-btn right">閉じる</button>
  </header>
  <div class="body">
    <div class="tabs">
      <button class="tab active" data-tab="reg">登録</button>
      <button class="tab" data-tab="del">削除（通報）</button>
      <button class="tab" data-tab="mine">自分の登録</button>
    </div>

    <div id="pane-reg">
      <div class="note">
        晴れる屋デッキのURL（または数字ID）を入力して「登録」<br>
        形式: https://www.hareruyamtg.com/decks/＜数字＞
      </div>
      <div class="search-row">
        <input type="text" id="regUrl" placeholder="例: https://www.hareruyamtg.com/decks/0000000">
        <button id="regBtn" class="small-btn">登録</button>
      </div>
      <div class="msg" id="regMsg"></div>
    </div>

    <div id="pane-del" style="display:none">
      <div class="note">削除してほしいデッキのURL（または数字ID）を入力して「通報」。一定数で自動削除。</div>
      <div class="search-row">
        <input type="text" id="delUrl" placeholder="例: https://www.hareruyamtg.com/decks/0000000">
        <button id="delBtn" class="small-btn">通報</button>
      </div>
      <div class="msg" id="delMsg"></div>
    </div>

    <div id="pane-mine" style="display:none">
      <div class="note">あなたが登録したデッキ一覧（最大50件）。ここから削除できます。</div>
      <div style="display:flex;gap:8px;margin-bottom:6px">
        <button id="reloadMine" class="small-btn">更新</button>
      </div>
      <div id="mineList" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>
  </div>
</aside>

<div class="toast" id="toast"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

/* ====== Supabase 設定 ====== */
const SUPABASE_URL  = "https://onzljxnqlrohkzsfxqbh.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uemxqeG5xbHJvaGt6c2Z4cWJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUzNTksImV4cCI6MjA3MTE1MTM1OX0.eLAP_-PtVm6tBFFCNfOVsTqEcvtZK3x3QFFNeRpxuj8";
const FN_INGEST     = `${SUPABASE_URL}/functions/v1/ingest-hareruya`;
const FN_REPORT     = `${SUPABASE_URL}/functions/v1/report-deck`;
const FN_DELETE_OWN = `${SUPABASE_URL}/functions/v1/delete-own-deck`;
const FN_VOTE       = `${SUPABASE_URL}/functions/v1/vote`;
const FN_SKIP       = `${SUPABASE_URL}/functions/v1/skip`;
const APP_URL       = `${location.origin}${location.pathname}`;

const sb = createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: { persistSession:false, autoRefreshToken:false },
  global: { headers: { apikey: SUPABASE_ANON } },
});

/* ====== Util ====== */
const $ = (q)=>document.querySelector(q);
const sid = (localStorage.getItem("sid") || (crypto?.randomUUID?.() ? crypto.randomUUID() : String(Math.random()).slice(2)+"-"+Date.now()));
localStorage.setItem("sid", sid);

const toastEl = $("#toast");
function toast(msg){ toastEl.textContent=msg; toastEl.style.display="block"; clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.style.display="none", 2000); }

function toDeckId(input){
  const s = String(input||"").trim();
  return s.match(/decks\/(\d+)/)?.[1]
      || s.match(/deck\.hareruyamtg\.com\/(\d+)/)?.[1]
      || (/^\d{4,}$/.test(s) ? s : null);
}
function canonUrl(input){ const id = toDeckId(input); return id ? `https://www.hareruyamtg.com/decks/${id}` : null; }

/* ====== 埋め込み ====== */
const frame = $("#deckFrame"), fail = $("#embedFail");
const openHareruyaLink = $("#openHareruyaLink"), retryEmbed = $("#retryEmbed");
let embedWatch = null;
function setEmbed(inputUrl){
  const s = String(inputUrl || "").trim();
  const m = s.match(/decks\/(\d+)/) || s.match(/deck\.hareruyamtg\.com\/(\d+)/) || s.match(/^(\d{4,})$/);
  const id = m ? m[1] : null;
  if (!id) { frame.src = "about:blank"; fail.style.display="flex"; return; }
  const wwwUrl  = `https://www.hareruyamtg.com/decks/${id}`;
  openHareruyaLink.href = wwwUrl;
  fail.style.display="none"; frame.removeAttribute("src"); frame.src = wwwUrl;
  clearTimeout(embedWatch); embedWatch = setTimeout(()=>{ fail.style.display="flex"; }, 6000);
}
frame.addEventListener("load", ()=> { clearTimeout(embedWatch); });
retryEmbed.addEventListener("click", ()=> { if (currentDeck?.source_url) setEmbed(currentDeck.source_url); });

/* ====== 状態 ====== */
let currentDeck = null;
let autoNextTimer = null;

/* ====== 集計 ====== */
const resultsEl = $("#results");
const seg1=$("#seg1"), seg2=$("#seg2"), seg3=$("#seg3"), seg4=$("#seg4");
const p1=$("#p1"), p2=$("#p2"), p3=$("#p3"), p4=$("#p4");
const nextBtn=$("#nextBtn");
const autoNextHint=$("#autoNextHint");

// 反応時間計測
let deckShownAtMs = 0;
// 既に自分が投票済みか
let hadMyVoteBefore = false;

function renderChart(c1,c2,c3,c4){
  const total=Math.max(0,c1+c2+c3+c4);
  const per = total? [c1/total*100,c2/total*100,c3/total*100,c4/total*100]:[0,0,0,0];
  const l1 = 0, l2 = per[0], l3 = per[0]+per[1], l4 = per[0]+per[1]+per[2];
  seg1.style.left=`${l1}%`; seg1.style.width=`${per[0]}%`;
  seg2.style.left=`${l2}%`; seg2.style.width=`${per[1]}%`;
  seg3.style.left=`${l3}%`; seg3.style.width=`${per[2]}%`;
  seg4.style.left=`${l4}%`; seg4.style.width=`${per[3]}%`;
  p1.textContent=`${Math.round(per[0])}%`;
  p2.textContent=`${Math.round(per[1])}%`;
  p3.textContent=`${Math.round(per[2])}%`;
  p4.textContent=`${Math.round(per[3])}%`;
}
async function loadVotesAndRenderResults(forceShow=false){
  if(!currentDeck) return;
  const { data } = await sb.from("labels").select("bracket").eq("deck_id", currentDeck.id).limit(10000);
  let c1=0,c2=0,c3=0,c4=0;
  for(const r of (data||[])){
    if(r.bracket===1)c1++; else if(r.bracket===2)c2++; else if(r.bracket===3)c3++; else if(r.bracket===4)c4++;
  }
  renderChart(c1,c2,c3,c4); if(forceShow) resultsEl.style.display="flex";
}

/* ====== 自分の投票 ====== */
const voteChips = Array.from(document.querySelectorAll(".chip[data-vote]"));
function markMyVote(bracket){
  voteChips.forEach(btn=>{
    const isSel = Number(btn.dataset.vote) === Number(bracket);
    btn.classList.toggle("selected", !!bracket && isSel);
    btn.setAttribute("aria-pressed", String(!!bracket && isSel));
  });
}
async function loadMyVote(){
  if(!currentDeck) { markMyVote(null); hadMyVoteBefore=false; return null; }
  const { data } = await sb.from("labels")
    .select("bracket")
    .eq("deck_id", currentDeck.id)
    .eq("session_id", sid)
    .maybeSingle();
  const b = data?.bracket ?? null;
  hadMyVoteBefore = b !== null;
  markMyVote(b);
  return b;
}

/* ====== Mana/XP（ローカル保存） ====== */
const xpKey = "xp_v2";
const manaLvEl = $("#manaLv"), manaFill = $("#manaFill"), manaSyms = $("#manaSyms"), rtLabel = $("#rtLabel");

// levelごとの累積必要XP（Lv1..16）
const lvNeed = [10,30,70,150,310,630,1270,2550,5110,10230,20470,40950,81910,163830,327670,655350];

function loadXP(){ try{ return JSON.parse(localStorage.getItem(xpKey)||"{}"); }catch{ return {}; } }
function saveXP(s){ localStorage.setItem(xpKey, JSON.stringify(s)); }
function ensureXP(){
  const s = loadXP();
  s.xp ??= 0; s.lv ??= 0;
  s.mana ??= { C:0, W:0, U:0, B:0, R:0, G:0 }; // 無色C
  return s;
}

function updateXpUI(){
  const s = ensureXP();

  // 数値は見せず、バーの伸びのみ
  const prevNeed = s.lv ? lvNeed[s.lv-1] : 0;
  const nextNeed = lvNeed[s.lv] ?? lvNeed[lvNeed.length-1];
  const cur = Math.max(0, s.xp - prevNeed);
  const denom = Math.max(1, nextNeed - prevNeed);
  const pct = Math.max(0, Math.min(100, Math.round(cur / denom * 100)));

  manaLvEl.textContent = s.lv;     // 「0 Mana」
  manaFill.style.width = pct + "%";

  // 並び替え：無色 > W > U > B > R > G
  const order = ["C","W","U","B","R","G"];
  const syms = [];
  // 無色は ①②… で集約表示
  if (s.mana.C>0){
    const circled = (n)=>{
      const base = 9311; // ① U+2460
      return (n>=1 && n<=20) ? String.fromCharCode(base+n) : String(n);
    };
    syms.push(`<span class="sym C">${circled(s.mana.C)}</span>`);
  }
  for(const k of order.slice(1)){
    for(let i=0;i<s.mana[k];i++){
      syms.push(`<span class="sym ${k}">${k}</span>`);
    }
  }
  manaSyms.innerHTML = syms.join("");
}

/** レベルアップ時のマナ付与ルール（青=ぞろ目のみ、無色=未該当+末尾0秒） */
function awardManaByRule(rtSec){
  const now = new Date(); const h = now.getHours();
  const isAM = h < 12; const isPM = !isAM;
  const sec = now.getSeconds();
  const isZeroTail = (sec % 10 === 0);                                // 末尾0秒
  const isDbl = (Math.floor(sec/10) === (sec % 10) && sec !== 0);     // 11,22,33,44,55

  let color = "C"; // default 無色

  // 優先順：U(ぞろ目) → R/G/W/B → C(未該当 or 末尾0)
  if (isDbl) color = "U";
  else if (rtSec <= 20 && isPM) color = "R";
  else if (rtSec >= 50 && isAM) color = "G";
  else if (rtSec >=21 && rtSec <=59 && isAM) color = "W";
  else if (rtSec >=21 && rtSec <=59 && isPM) color = "B";
  else if (isZeroTail) color = "C"; // 末尾0秒は無色へ
  else color = "C";                 // どれにも当てはまらなければ無色

  const s = ensureXP();
  s.mana[color] = (s.mana[color]||0) + 1;
  saveXP(s);
  updateXpUI();
}

/** 1デッキ1回だけXPを付与（“ぞろ目秒”なら +1 ボーナス） */
function addXPIfFirstVote(rtSec){
  if (hadMyVoteBefore) return; // 1デッキ1XP

  const s = ensureXP();

  // 基本 +1、投票成立時が「ぞろ目秒」なら +1 ボーナス
  let delta = 1;
  const nowSec = (new Date()).getSeconds();
  const isDbl = (Math.floor(nowSec/10) === (nowSec % 10) && nowSec !== 0); // 11,22,33,44,55
  if (isDbl) delta += 1;

  s.xp = (s.xp||0) + delta;

  // レベルアップ判定
  const nextLvNeed = lvNeed[s.lv] ?? Infinity;
  if (s.xp >= nextLvNeed){
    s.lv++;
    saveXP(s);
    awardManaByRule(rtSec);
  }else{
    saveXP(s);
  }
  updateXpUI();
}

/* ====== 表示 ====== */
async function showDeckByRow(row,{showResults=false}={}){
  currentDeck = row;
  markMyVote(null);
  setEmbed(row.source_url);

  const id = toDeckId(row.source_url);
  if (id) history.replaceState(null, "", `${APP_URL}?deck=${id}`);

  const titleEl=document.querySelector('[data-deck-title]');
  titleEl.textContent = row.deck_name || (id ? `Hareruya Deck #${id}` : "Hareruya Deck");
  titleEl.href = row.source_url;

  $("#results").style.display = showResults ? "flex":"none";
  await loadVotesAndRenderResults(showResults);
  await loadMyVote();

  clearInterval(autoNextTimer); autoNextTimer=null; autoNextHint.textContent="";

  // インプレッション記録 & 反応時間開始
  try{ await sb.rpc("log_impression",{ p_session:sid, p_deck: row.id }); }catch(_){}
  deckShownAtMs = performance.now();
}

/* ====== ランダム（未回答優先 + “新しい/投票少ない”を優先） ====== */
async function loadRandomDeck(){
  const { data, error } = await sb.rpc("random_deck_for_session", { p_session: sid });
  if (error) { toast("読み込みエラー"); return; }
  const row = (Array.isArray(data) ? data[0] : null);
  if (!row) { toast("未回答のデッキがありません"); return; }
  await showDeckByRow(row,{showResults:false});
}

/* ====== 登録存在確認 ====== */
async function ensureDeckExists(url){
  const { data } = await sb.from("decks").select("id,source_url,deck_name,registered_at").eq("source_url", url).maybeSingle();
  if(data?.id) return data;
  const res = await fetch(FN_INGEST,{
    method:"POST",
    headers:{ "Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON,"apikey":SUPABASE_ANON },
    body: JSON.stringify({ url, session_id:sid })
  });
  const j = await res.json().catch(()=> ({}));
  if(res.ok && j.ok){
    const { data: after } = await sb.from("decks").select("id,source_url,deck_name,registered_at").eq("source_url", url).maybeSingle();
    if(after?.id) return after;
  }
  throw new Error(j?.error || "登録に失敗しました");
}

/* ====== 投票 ====== */
let voting = false;
function setVoting(b){ voting=b; voteChips.forEach(btn => btn.disabled = b); }

async function postVoteOnce(bracket, rtSec){
  const res = await fetch(FN_VOTE, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + SUPABASE_ANON,
      "apikey": SUPABASE_ANON
    },
    body: JSON.stringify({
      deck_id: currentDeck.id,
      session_id: sid,
      bracket,
      rt_sec: rtSec
    })
  });
  let ok = res.ok;
  try {
    const j = await res.clone().json();
    if (j && j.ok === false) ok = false;
  } catch(_){}
  return { ok, status: res.status };
}

async function postVoteWithRetry(bracket, rtSec){
  const retriable = new Set([429, 409, 500, 502, 503, 504]);
  for (let i=0; i<2; i++){
    const { ok, status } = await postVoteOnce(bracket, rtSec);
    if (ok) return true;
    if (!retriable.has(status)) return false;
    await new Promise(r=>setTimeout(r, 250));
  }
  return false;
}

document.querySelectorAll(".chip[data-vote]").forEach(el =>
  el.addEventListener("click", async (e)=>{
    if (!currentDeck || voting) return;

    const bracket = Number(e.currentTarget.dataset.vote);
    setVoting(true);

    try{
      const rtSec = Math.max(0, Math.round((performance.now() - deckShownAtMs)/1000));
      const done = await postVoteWithRetry(bracket, rtSec);
      if (!done){
        toast("保存エラー。少し時間をおいて再試行してください。");
        return;
      }

      markMyVote(bracket);

      // 初回投票直後の連打でもXPが増えないよう即座にフラグを立てる
      if (!hadMyVoteBefore) hadMyVoteBefore = true;

      resultsEl.style.display="flex";
      await loadVotesAndRenderResults(true);

      // 1デッキ1XP（ぞろ目秒なら+1ボーナス）
      addXPIfFirstVote(rtSec);

      // 反応時間表示（投票後のみ）
      const rt = document.getElementById("rtLabel");
      if (rt){ rt.style.display="inline"; rt.textContent = `${rtSec}sec`; }

      let left = 10;
      autoNextHint.textContent = `${left}秒後に自動で次のデッキへ`;
      clearInterval(autoNextTimer);
      autoNextTimer = setInterval(()=>{
        left--;
        if(left<=0){
          clearInterval(autoNextTimer);
          autoNextTimer=null;
          loadRandomDeck();
        }else{
          autoNextHint.textContent = `${left}秒後に自動で次のデッキへ`;
        }
      }, 1000);
    }catch{
      toast("保存エラーが発生しました。");
    }finally{
      setVoting(false);
    }
  })
);

/* ====== スキップ・次へ ====== */
async function onSkip(){
  try{
    if (currentDeck) {
      await fetch(FN_SKIP, {
        method: "POST",
        headers: { "Content-Type":"application/json", "Authorization":"Bearer "+SUPABASE_ANON, "apikey": SUPABASE_ANON },
        body: JSON.stringify({ deck_id: currentDeck.id, session_id: sid })
      });
    }
  }catch(_){}
  clearInterval(autoNextTimer); autoNextTimer=null;
  await loadRandomDeck();
}
$("#skipBtn").addEventListener("click", onSkip);
nextBtn.addEventListener("click", ()=> { clearInterval(autoNextTimer); autoNextTimer=null; loadRandomDeck(); });

/* ====== 検索 ====== */
async function doSearch(){
  const v=$("#searchInput").value.trim(); const url = canonUrl(v);
  if(!url){ toast("URLまたは数字IDを入力してください。"); return; }
  try{ const row = await ensureDeckExists(url); await showDeckByRow(row,{showResults:true}); } catch(e){ toast(String(e.message||e)); }
}
$("#searchBtn").addEventListener("click", doSearch);
$("#searchInput").addEventListener("keydown", e=>{ if(e.key==="Enter") doSearch(); });

/* ====== 共有 ====== */
function currentDeckLink(){
  const id = currentDeck ? toDeckId(currentDeck.source_url) : null;
  return id ? `${APP_URL}?deck=${id}` : APP_URL;
}
function shareCurrentDeck(){
  const url = currentDeckLink();
  const text = `このデッキのブラケットは？\n${url}\n#みんなでブラケット診断`;
  const tw = new URL("https://x.com/intent/tweet"); tw.searchParams.set("text", text);
  const w = window.open(tw.toString(), "_blank", "noopener,noreferrer");
  if (!w) toast("ブラウザにポップアップをブロックされました。");
}
$("#shareBtn").addEventListener("click", shareCurrentDeck);

/* ====== 通報 ====== */
$("#reportBtn").addEventListener("click", async ()=>{
  if(!currentDeck) return toast("デッキが読み込まれていません");
  const btn = $("#reportBtn"); const orig = btn.textContent;
  btn.textContent="送信中…"; btn.classList.add("primary","ghost");
  try{
    const res = await fetch(FN_REPORT,{
      method:"POST",
      headers:{ "Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON,"apikey":SUPABASE_ANON },
      body: JSON.stringify({ deck_id: currentDeck.id, session_id: sid, reason:"user_report_from_vote" })
    });
    const j = await res.json().catch(()=> ({}));
    if(res.ok && j?.ok!==false){
      btn.textContent="完了！"; toast("報告ありがとうございました");
      setTimeout(()=>{ btn.textContent=orig; btn.classList.remove("primary","ghost"); onSkip(); }, 900);
    }else{
      btn.textContent=orig; btn.classList.remove("primary","ghost");
      toast("報告に失敗しました");
    }
  }catch{
    btn.textContent=orig; btn.classList.remove("primary","ghost");
    toast("報告に失敗しました");
  }
});

/* ====== シート ====== */
const sheet=$("#sheet"), backdrop=$("#backdrop");
function openSheet(){ sheet.style.display="flex"; backdrop.style.display="block"; }
function closeSheet(){ sheet.style.display="none"; backdrop.style.display="none"; }
$("#openSheet").addEventListener("click", openSheet);
$("#closeSheet").addEventListener("click", closeSheet);
backdrop.addEventListener("click", closeSheet);

/* ====== タブ ====== */
const tabs = document.querySelectorAll(".tab");
tabs.forEach(t=> t.addEventListener("click", ()=>{
  tabs.forEach(x=>x.classList.remove("active")); t.classList.add("active");
  const name=t.dataset.tab;
  $("#pane-reg").style.display = name==="reg" ? "block":"none";
  $("#pane-del").style.display = name==="del" ? "block":"none";
  $("#pane-mine").style.display= name==="mine"? "block":"none";
  if(name==="mine") loadMine();
}));

/* ====== 登録 ====== */
$("#regBtn").addEventListener("click", async ()=>{
  const msg=$("#regMsg"); msg.textContent="";
  const v=$("#regUrl").value.trim(); const url=canonUrl(v); if(!url){ msg.textContent="URL形式が正しくありません。"; return; }
  msg.textContent="登録中...";
  try{
    const res = await fetch(FN_INGEST,{ method:"POST", headers:{ "Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON,"apikey":SUPABASE_ANON }, body: JSON.stringify({ url, session_id:sid }) });
    const j = await res.json().catch(()=> ({}));
    if(res.ok && j.ok){
      msg.textContent = "登録しました。";
      try{ const row = await ensureDeckExists(url); await showDeckByRow(row,{showResults:false}); }catch{}
      loadMine();
    }else{ msg.textContent = `登録失敗: ${j?.error || res.statusText}`; }
  }catch{ msg.textContent="登録に失敗しました。"; }
});

/* ====== 通報タブ ====== */
$("#delBtn").addEventListener("click", async ()=>{
  const msg=$("#delMsg"); msg.textContent="";
  const v=$("#delUrl").value.trim(); const url=canonUrl(v); if(!url){ msg.textContent="URL形式が正しくありません。"; return; }
  const { data } = await sb.from("decks").select("id").eq("source_url", url).maybeSingle();
  if(!data?.id){ msg.textContent="まだ登録されていない可能性があります。"; return; }
  try{
    const res = await fetch(FN_REPORT,{
      method:"POST",
      headers:{ "Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON,"apikey":SUPABASE_ANON },
      body: JSON.stringify({ deck_id: data.id, session_id: sid, reason:"user_delete_request" })
    });
    const j = await res.json().catch(()=> ({}));
    (res.ok && j?.ok!==false) ? (msg.textContent="報告を受け付けました。ありがとうございました。") : (msg.textContent=`報告に失敗しました: ${j?.error || res.statusText}`);
  }catch{ msg.textContent="報告に失敗しました。"; }
});

/* ====== 自分の登録 ====== */
$("#reloadMine").addEventListener("click", ()=> loadMine());
async function loadMine(){
  const listEl=$("#mineList");
  listEl.innerHTML="読み込み中…";
  const { data, error } = await sb.from("decks").select("id,source_url,deck_name,created_at").eq("created_by_session", sid).order("created_at",{ascending:false}).limit(50);
  if(error){ listEl.textContent="読み込みエラー"; return; }
  if(!data || data.length===0){ listEl.textContent="まだ登録がありません。"; return; }
  listEl.innerHTML="";
  for(const d of data){
    const idNum = toDeckId(d.source_url) || d.id;
    const item=document.createElement("div"); item.className="item";
    const a=document.createElement("a"); a.href=d.source_url; a.target="_blank"; a.rel="noopener noreferrer";
    a.textContent = idNum; // 1081165 だけ表示
    const del=document.createElement("button"); del.className="small-btn"; del.textContent="削除";
    del.addEventListener("click", ()=> deleteOwn(d.id, item));
    const show=document.createElement("button"); show.className="small-btn"; show.textContent="表示";
    show.addEventListener("click", async ()=> {
      const row = await sb.from("decks").select("id,source_url,deck_name,registered_at").eq("id", d.id).maybeSingle();
      if(row.data) await showDeckByRow(row.data,{showResults:false});
      closeSheet();
    });
    item.append(a, show, del);
    listEl.appendChild(item);
  }
}
async function deleteOwn(deck_id, node){
  if(!confirm("この登録を削除しますか？（投票/通報も削除されます）")) return;
  try{
    const res = await fetch(FN_DELETE_OWN,{
      method:"POST",
      headers:{ "Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON,"apikey":SUPABASE_ANON },
      body: JSON.stringify({ deck_id, session_id: sid })
    });
    const j = await res.json().catch(()=> ({}));
    if(res.ok && j?.ok){ toast("削除しました"); node?.remove(); if(currentDeck?.id===deck_id) loadRandomDeck(); }
    else toast(`削除に失敗しました: ${j?.error || res.statusText}`);
  }catch{ toast("削除に失敗しました。"); }
}

/* ====== 起動 ====== */
updateXpUI();
const paramDeck = new URLSearchParams(location.search).get("deck");
if (paramDeck) {
  const url = canonUrl(paramDeck);
  if (url) {
    try { const row = await ensureDeckExists(url); await showDeckByRow(row, { showResults: true }); }
    catch { await loadRandomDeck(); }
  } else { await loadRandomDeck(); }
} else { await loadRandomDeck(); }
</script>
</body>
</html>
