<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ã¿ã‚“ãªã§ãƒ–ãƒ©ã‚±ãƒƒãƒˆè¨ºæ–­</title>

  <!-- perf -->
  <link rel="preconnect" href="https://esm.sh" crossorigin>
  <link rel="preconnect" href="https://www.hareruyamtg.com" crossorigin>
  <link rel="dns-prefetch" href="//www.hareruyamtg.com">

  <style>
    :root{
      --bg:#fff; --fg:#111; --muted:#6b7280; --card:#fff; --border:#e5e7eb;
      --brand:#d62828;
      --c1:#6EE7B7; --c2:#4E9CFF; --c3:#FFC857; --c4:#FF6B6B;
      --radius:14px;
      --xblue:#1d9bf0; --danger:#ef4444; --link:#2563eb;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:"Inter","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--fg);background:var(--bg)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 0 12px}
    .title{display:flex;flex-direction:column;gap:4px;min-width:0}
    .site{font-weight:800;letter-spacing:.01em;font-size:20px;text-decoration:none;color:inherit}
    @media(min-width:1000px){ .site{font-size:24px} }
    .deck-meta{display:flex;align-items:center;gap:10px;flex-wrap:nowrap;color:var(--muted);font-size:13px;min-width:0}
    .deck-meta a[data-deck-title]{color:var(--link);text-decoration:underline;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:min(80vw,600px)}

    .small-btn{font-size:13px;border:1px solid var(--border);background:#fff;color:#374151;border-radius:999px;padding:6px 12px;cursor:pointer}
    .small-btn:hover{background:#fafafa}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}

    .grid{display:grid;gap:16px}
    @media(min-width:1000px){ .grid{grid-template-columns:1.2fr .8fr} }

    /* åŸ‹ã‚è¾¼ã¿ */
    .embed-wrap{position:relative;background:#fff;border-radius:var(--radius);overflow:hidden;border:1px solid var(--border)}
    iframe{width:100%;height:70vh;min-height:520px;border:0;display:block;background:#fff}
    .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(0deg, rgba(255,255,255,.94), rgba(255,255,255,.94));text-align:center;padding:18px}
    .overlay .box{max-width:560px}
    .overlay .box h3{margin:0 0 8px;font-size:18px}
    .overlay .box p{margin:6px 0;color:#4b5563;font-size:14px}
    .overlay .box .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .overlay .box a, .overlay .box button{border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:#fff;cursor:pointer;font-size:14px}

    /* æŠ•ç¥¨ */
    .vote-card{display:flex;flex-direction:column;gap:12px}
    .vote-block{padding:12px;border:1px dashed var(--border);border-radius:14px;background:#fafafa}
    .prompt{font-weight:800;letter-spacing:.01em;font-size:16px}
    @media(min-width:1000px){ .prompt{font-size:20px} }

    .vote-row{display:grid; gap:10px; grid-template-columns:1fr 1fr; margin-top:10px}
    @media(min-width:1000px){ .vote-row{grid-template-columns:repeat(4,1fr)} }
    .chip{width:100%; height:64px; font-size:22px; font-weight:800; border:1px solid var(--border); border-radius:12px; background:#f4f4f5; cursor:pointer; transition:transform .07s ease, background .15s ease, box-shadow .15s ease;}
    .chip:hover{background:#e9e9eb} .chip:active{transform:scale(.98)}
    .b1{background:color-mix(in srgb, var(--c1) 18%, white)}
    .b2{background:color-mix(in srgb, var(--c2) 16%, white)}
    .b3{background:color-mix(in srgb, var(--c3) 20%, white)}
    .b4{background:color-mix(in srgb, var(--c4) 20%, white)}
    @media(min-width:1000px){ .chip{height:72px; font-size:24px} }
    .chip.selected{outline:2px solid var(--brand); box-shadow:0 0 0 4px color-mix(in srgb, var(--brand) 20%, transparent) inset; transform: translateY(-1px);}
    .chip[disabled]{opacity:.6; pointer-events:none; filter:grayscale(.2)}

    .skip-row{margin-top:6px}
    .skip{font-size:12px;color:#6b7280;text-decoration:underline;background:transparent;border:0;cursor:pointer;white-space:nowrap}

    /* çµæœ */
    .results{display:none;flex-direction:column;gap:8px}
    .bar{position:relative;height:30px;border-radius:4px;background:#f3f4f6;border:1px solid #e5e7eb;overflow:hidden}
    .seg{position:absolute;top:0;bottom:0}
    .seg.b1{background:var(--c1)} .seg.b2{background:var(--c2)} .seg.b3{background:var(--c3)} .seg.b4{background:var(--c4)}
    .legend{display:flex;gap:10px;flex-wrap:wrap;color:#374151;font-size:13px}
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block}
    .hint{font-size:12px;color:var(--muted)}
    .primary-btn{background:#fff; color:var(--brand); border:1.5px solid var(--brand); border-radius:12px; padding:8px 14px; font-weight:700; font-size:14px;}
    .primary-btn:hover{ background:color-mix(in srgb, var(--brand) 8%, #fff) }

    /* å…±æœ‰/å‰Šé™¤ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ */
    .btns-row{display:flex;gap:8px;flex-wrap:wrap}
    .btn-x{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--xblue); color:#0b67a7; background:#fff; border-radius:12px; padding:6px 10px; font-weight:600; font-size:13px;}
    .btn-x:hover{ background:#f0f8ff }
    .btn-danger-ghost{display:inline-flex; align-items:center; border:1px solid color-mix(in srgb, var(--danger) 50%, #eee); color:var(--danger); background:#fff; border-radius:12px; padding:6px 10px; font-size:13px;}
    .btn-danger-ghost:hover{ background:#fff5f5 }

    /* æ¤œç´¢ */
    .search-card .prompt{font-weight:600;font-size:13px;color:var(--muted)}
    .search-row{display:flex;gap:8px;flex-wrap:wrap}
    .search-inline{display:grid; grid-template-columns:1fr auto; align-items:center}
    .search-card input[type="text"]{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px;}

    /* Mana/XPï¼šã‚«ãƒ¼ãƒ‰æœ€ä¸‹éƒ¨ãƒ»æ§ãˆã‚ */
    .hud{margin-top:10px; font-size:12px; color:#6b7280; display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .hud .progress{position:relative; width:140px; height:6px; border-radius:999px; background:#eee; overflow:hidden; border:1px solid #e5e7eb}
    .hud .progress i{position:absolute; inset:0 auto 0 0; width:0; background:#e11d48; opacity:.7}
    .hud .rt{min-width:36px; text-align:right}

    .mana-pips{display:flex;gap:6px;align-items:center}
    .mana{width:16px;height:16px;border-radius:999px;display:inline-grid;place-items:center;font-size:10px;font-weight:800;color:#fff;opacity:.9}
    .mana.W{background:#f8f9fb;color:#111;border:1px solid #d1d5db}
    .mana.U{background:#3B82F6}
    .mana.B{background:#111}
    .mana.R{background:#EF4444}
    .mana.G{background:#10B981}
    .mana.C{background:#9CA3AF;color:#111}

    /* è‡ªåˆ†ã®ç™»éŒ²ï¼ˆãƒŸãƒ‹é›†è¨ˆï¼‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */
    .mini {display:flex; align-items:center; gap:8px; margin-left:auto; position:relative}
    .miniBar{position:relative; width:120px; height:12px; border-radius:4px; background:#f3f4f6; border:1px solid #e5e7eb; overflow:hidden}
    .miniSeg{position:absolute; top:0; bottom:0}
    .miniSeg.b1{background:var(--c1)} .miniSeg.b2{background:var(--c2)} .miniSeg.b3{background:var(--c3)} .miniSeg.b4{background:var(--c4)}
    .miniOverlay{display:none; position:absolute; inset:auto 0 100% auto; transform:translateY(-6px); background:rgba(17,24,39,.92); color:#fff; font-size:11px; padding:6px 8px; border-radius:6px; white-space:nowrap; box-shadow:0 4px 10px rgba(0,0,0,.2);}
    .mini:hover .miniOverlay{display:block}

    /* ã‚·ãƒ¼ãƒˆã®å…¥åŠ›æ¬„ã‚’æ¨ªã„ã£ã±ã„ã« */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none}
    .sheet{position:fixed;right:0;top:0;bottom:0;width:min(520px,100%);background:#fff;box-shadow:-10px 0 30px rgba(0,0,0,.2);display:none;flex-direction:column}
    .sheet header{padding:16px;border-bottom:1px solid var(--border)}
    .sheet .body{padding:16px;display:flex;flex-direction:column;gap:12px;overflow:auto;max-height:calc(100vh - 56px)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:13px}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
    .sheet .body .search-row{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
    .sheet .body input[type="text"]{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px}

    .note{font-size:12px;color:var(--muted);line-height:1.6}
    .msg{font-size:14px}
    .item{display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:10px;padding:8px}
    .item a{color:#111;text-decoration:none}
    .item a:hover{text-decoration:underline}

    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;display:none}

    /* NOTEï¼šã‚¹ãƒãƒ›ã¯æ”¹è¡ŒOKï¼PCã¯1è¡Œ */
    .nowrap-note{white-space:normal}
    @media (min-width: 700px){ .nowrap-note{white-space:nowrap} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <a class="site" href="./">ã¿ã‚“ãªã§ãƒ–ãƒ©ã‚±ãƒƒãƒˆè¨ºæ–­</a>
        <div class="deck-meta">
          <a data-deck-title id="deckTitle" href="#" target="_blank" rel="noopener noreferrer">Hareruya Deck</a>
          <span data-deck-date style="display:none">0000/00/00</span>
        </div>
      </div>
      <button id="openSheet" class="small-btn">ç™»éŒ² / å‰Šé™¤</button>
    </header>

    <div class="grid">
      <div class="embed-wrap card">
        <iframe id="deckFrame" title="Hareruya Deck"
                sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation-by-user-activation"
                loading="eager"></iframe>
        <div class="overlay" id="embedFail">
          <div class="box">
            <h3>ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã§ã—ãŸ</h3>
            <p>ãƒ–ãƒ©ã‚¦ã‚¶ã‚„æ‹¡å¼µæ©Ÿèƒ½ã®åˆ¶é™ã§åŸ‹ã‚è¾¼ã¿ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã„ã¦ãã ã•ã„ã€‚</p>
            <div class="row">
              <a id="openHareruyaLink" target="_blank" rel="noopener noreferrer">hareruyamtg.com ã§é–‹ã</a>
              <button id="retryEmbed">å†èª­ã¿è¾¼ã¿</button>
            </div>
            <p class="note" style="margin-top:10px">â€» iOS/Safariã®å ´åˆã€ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°é˜²æ­¢/ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚«ãƒ¼è¨­å®šã«ã‚ˆã‚Šè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>
          </div>
        </div>
      </div>

      <div class="card vote-card">
        <div class="vote-block">
          <div class="prompt">ã“ã®ãƒ‡ãƒƒã‚­ã®ãƒ–ãƒ©ã‚±ãƒƒãƒˆã¯ï¼Ÿ</div>
          <div class="vote-row">
            <button class="chip b1" data-vote="1">ï¼‘</button>
            <button class="chip b2" data-vote="2">ï¼’</button>
            <button class="chip b3" data-vote="3">ï¼“</button>
            <button class="chip b4" data-vote="4">ï¼”</button>
          </div>
          <div class="skip-row">
            <button class="skip" id="skipBtn" title="ã“ã®ãƒ‡ãƒƒã‚­ã¯è©•ä¾¡ã—ãªã„">å›ç­”ã—ãªã„</button>
          </div>
          <div class="hint">â€» åŒã˜ãƒ‡ãƒƒã‚­ã¯1ã¤ã ã‘è¨˜éŒ²ï¼ˆã‚ã¨ã‹ã‚‰å¤‰æ›´ã§ãã¾ã™ï¼‰</div>
        </div>

        <div class="results" id="results">
          <div class="bar" aria-label="é›†è¨ˆãƒãƒ¼">
            <div class="seg b1" id="seg1" style="left:0;width:0%"></div>
            <div class="seg b2" id="seg2" style="left:0;width:0%"></div>
            <div class="seg b3" id="seg3" style="left:0;width:0%"></div>
            <div class="seg b4" id="seg4" style="left:0;width:0%"></div>
          </div>
          <div class="legend">
            <span><i class="dot" style="background:var(--c1)"></i> 1 <b id="p1">0%</b></span>
            <span><i class="dot" style="background:var(--c2)"></i> 2 <b id="p2">0%</b></span>
            <span><i class="dot" style="background:var(--c3)"></i> 3 <b id="p3">0%</b></span>
            <span><i class="dot" style="background:var(--c4)"></i> 4 <b id="p4">0%</b></span>
          </div>
          <div class="hint" id="deckRtStat" style="display:none"></div>

          <div style="display:flex;gap:8px;margin-top:2px;align-items:center;flex-wrap:wrap">
            <button id="nextBtn" class="primary-btn">â–¶ æ¬¡ã®ãƒ‡ãƒƒã‚­ã¸</button>
            <span class="hint" id="autoNextHint"></span>
          </div>
        </div>

        <!-- â–¼ å…±æœ‰/å‰Šé™¤ï¼šå¸¸æ™‚è¡¨ç¤º -->
        <div class="btns-row" style="margin-top:6px">
          <button id="shareBtn" class="btn-x" title="Xã§å…±æœ‰">X ã§ã‚·ã‚§ã‚¢</button>
          <button id="reportBtn" class="btn-danger-ghost" title="ã“ã®ãƒ‡ãƒƒã‚­ã«å‰Šé™¤å¸Œæœ›ã‚’å‡ºã™">å‰Šé™¤å¸Œæœ›</button>
        </div>
        <!-- â–² å…±æœ‰/å‰Šé™¤ -->

        <!-- â–¼ Mana/XPï¼ˆæœ€ä¸‹éƒ¨ãƒ»æ§ãˆã‚ï¼‰ -->
        <div class="hud" id="hud">
          <span>Mana <b id="lv">0</b> Â· <span id="xp">0</span>XP</span>
          <div class="progress"><i id="xpbar"></i></div>
          <span class="rt" id="lastRtHud" style="display:none">0.0s</span>
          <div class="mana-pips" id="pips"></div>
        </div>
        <!-- â–² Mana/XP -->
      </div>
    </div>

    <div class="card search-card" style="margin-top:16px">
      <div class="prompt">æ¤œç´¢</div>
      <div class="search-row search-inline">
        <input type="text" id="searchInput" placeholder="ä¾‹: https://www.hareruyamtg.com/decks/0000000  ã¾ãŸã¯ 0000000">
        <button id="searchBtn" class="small-btn" style="background:#fff">æ¤œç´¢</button>
      </div>
    </div>

    <footer class="card" style="margin-top:16px">
      <div class="note">
        â€» æœ¬ã‚µã‚¤ãƒˆã¯å¤–éƒ¨ã‚µã‚¤ãƒˆã®ãƒšãƒ¼ã‚¸ã‚’åŸ‹ã‚è¾¼ã¿è¡¨ç¤ºã—ã¾ã™ã€‚æ²è¼‰URLã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿ã§ã‚ã‚Šã€
        å†…å®¹ã®æ­£ç¢ºæ€§ãƒ»åˆæ³•æ€§ã‚’ä¿è¨¼ã—ã¾ã›ã‚“ã€‚è‘—ä½œæ¨©ç­‰ã®æ¨©åˆ©ã¯å„æ¨©åˆ©è€…ã«å¸°å±ã—ã¾ã™ã€‚
        ä¸é©åˆ‡ãƒ»æ¨©åˆ©ä¾µå®³ã®ç–‘ã„ãŒã‚ã‚‹URLã¯ã€Œå‰Šé™¤å¸Œæœ›ã€ã‹ã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚å¿…è¦ã«å¿œã˜ã¦å‰Šé™¤å¯¾å¿œã—ã¾ã™ã€‚
      </div>
    </footer>
  </div>

  <!-- å³ã‚·ãƒ¼ãƒˆ -->
  <div class="sheet-backdrop" id="backdrop"></div>
  <aside class="sheet" id="sheet">
    <header>
      <div style="font-weight:700">ç™»éŒ² / å‰Šé™¤</div>
      <button id="closeSheet" class="small-btn right">é–‰ã˜ã‚‹</button>
    </header>
    <div class="body">
      <div class="tabs">
        <button class="tab active" data-tab="reg">ç™»éŒ²</button>
        <button class="tab" data-tab="del">å‰Šé™¤ï¼ˆé€šå ±ï¼‰</button>
        <button class="tab" data-tab="mine">è‡ªåˆ†ã®ç™»éŒ²</button>
      </div>

      <div id="pane-reg">
        <div class="note">æ™´ã‚Œã‚‹å±‹ãƒ‡ãƒƒã‚­ã®URLï¼ˆã¾ãŸã¯æ•°å­—IDï¼‰ã‚’å…¥åŠ›ã—ã¦ã€Œç™»éŒ²ã€ã€‚</div>
        <div class="note">å½¢å¼: https://www.hareruyamtg.com/decks/ï¼œæ•°å­—ï¼</div>
        <div class="search-row">
          <input type="text" id="regUrl" placeholder="ä¾‹: https://www.hareruyamtg.com/decks/0000000">
          <button id="regBtn" class="small-btn">ç™»éŒ²</button>
        </div>
        <div class="msg" id="regMsg"></div>
      </div>

      <div id="pane-del" style="display:none">
        <div class="note">å‰Šé™¤ã—ã¦ã»ã—ã„ãƒ‡ãƒƒã‚­ã®URLï¼ˆã¾ãŸã¯æ•°å­—IDï¼‰ã‚’å…¥åŠ›ã—ã¦ã€Œé€šå ±ã€ã€‚ä¸€å®šæ•°ã§è‡ªå‹•å‰Šé™¤ã€‚</div>
        <div class="search-row">
          <input type="text" id="delUrl" placeholder="ä¾‹: https://www.hareruyamtg.com/decks/0000000">
          <button id="delBtn" class="small-btn">é€šå ±</button>
        </div>
        <div class="msg" id="delMsg"></div>
      </div>

      <div id="pane-mine" style="display:none">
        <div class="note">ã‚ãªãŸãŒç™»éŒ²ã—ãŸãƒ‡ãƒƒã‚­ä¸€è¦§ï¼ˆæœ€å¤§50ä»¶ï¼‰ã€‚ã“ã“ã‹ã‚‰å‰Šé™¤ã§ãã¾ã™ã€‚</div>
        <div style="display:flex;gap:8px;margin-bottom:6px">
          <button id="reloadMine" class="small-btn">æ›´æ–°</button>
        </div>
        <div id="mineList" style="display:flex;flex-direction:column;gap:8px"></div>
      </div>
    </div>
  </aside>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ========= è¨­å®š =========
    const SUPABASE_URL  = "https://onzljxnqlrohkzsfxqbh.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uemxqeG5xbHJvaGt6c2Z4cWJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUzNTksImV4cCI6MjA3MTE1MTM1OX0.eLAP_-PtVm6tBFFCNfOVsTqEcvtZK3x3QFFNeRpxuj8";
    const FN_INGEST     = `${SUPABASE_URL}/functions/v1/ingest-hareruya`;
    const FN_REPORT     = `${SUPABASE_URL}/functions/v1/report-deck`;
    const FN_DELETE_OWN = `${SUPABASE_URL}/functions/v1/delete-own-deck`;
    const FN_VOTE       = `${SUPABASE_URL}/functions/v1/vote`;
    const APP_URL       = `${location.origin}${location.pathname}`;
    const RPC_RANDOM    = "random_deck_for_session_v2";
    const SHOW_DECK_STATS = false;
    const DECK_STATS_DAYS = 14;
    const REPORT_NEXT_DELAY_MS = 1500;

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession:false, autoRefreshToken:false },
      global: { headers: { apikey: SUPABASE_ANON } },
    });

    // ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
    const $ = (q)=>document.querySelector(q);
    const sid = (localStorage.getItem("sid") || (crypto?.randomUUID?.() ? crypto.randomUUID() : String(Math.random()).slice(2)+"-"+Date.now()));
    localStorage.setItem("sid", sid);

    const toastEl = $("#toast");
    function toast(msg){ toastEl.textContent=msg; toastEl.style.display="block"; clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.style.display="none", 2000); }

    function toDeckId(input){
      const s = String(input||"").trim();
      return s.match(/decks\/(\d+)/)?.[1]
          || s.match(/deck\.hareruyamtg\.com\/(\d+)/)?.[1]
          || (/^\d{4,}$/.test(s) ? s : null);
    }
    function canonUrl(input){ const id = toDeckId(input); return id ? `https://www.hareruyamtg.com/decks/${id}` : null; }

    // ===== åŸ‹ã‚è¾¼ã¿ =====
    const frame = document.getElementById("deckFrame");
    const fail  = document.getElementById("embedFail");
    const openHareruyaLink = document.getElementById("openHareruyaLink");
    const retryEmbed = document.getElementById("retryEmbed");
    let embedWatch = null;

    function setEmbed(inputUrl){
      const s = String(inputUrl || "").trim();
      const m = s.match(/decks\/(\d+)/) || s.match(/deck\.hareruyamtg\.com\/(\d+)/) || s.match(/^(\d{4,})$/);
      const id = m ? m[1] : null;
      if (!id) { frame.src = "about:blank"; fail.style.display="flex"; return; }
      const wwwUrl  = `https://www.hareruyamtg.com/decks/${id}`;
      openHareruyaLink.href = wwwUrl;
      fail.style.display="none";
      frame.removeAttribute("src");
      frame.src = wwwUrl;
      clearTimeout(embedWatch);
      embedWatch = setTimeout(()=>{ fail.style.display="flex"; }, 4000);
    }
    frame.addEventListener("load", ()=> { clearTimeout(embedWatch); });
    retryEmbed.addEventListener("click", ()=> { if (currentDeck?.source_url) setEmbed(currentDeck.source_url); });

    // ========= çŠ¶æ…‹ =========
    let currentDeck = null;
    let autoNextTimer = null;

    // ========= é›†è¨ˆ =========
    const resultsEl = $("#results");
    const seg1=$("#seg1"), seg2=$("#seg2"), seg3=$("#seg3"), seg4=$("#seg4");
    const p1=$("#p1"), p2=$("#p2"), p3=$("#p3"), p4=$("#p4");
    const nextBtn=$("#nextBtn");
    const autoNextHint=$("#autoNextHint");
    const lastRtHud = $("#lastRtHud");

    function renderChart(c1,c2,c3,c4){
      const total=Math.max(0,c1+c2+c3+c4);
      const per = total? [c1/total*100,c2/total*100,c3/total*100,c4/total*100]:[0,0,0,0];
      const l1=0, l2=per[0], l3=per[0]+per[1], l4=per[0]+per[1]+per[2];
      seg1.style.left=`${l1}%`; seg1.style.width=`${per[0]}%`;
      seg2.style.left=`${l2}%`; seg2.style.width=`${per[1]}%`;
      seg3.style.left=`${l3}%`; seg3.style.width=`${per[2]}%`;
      seg4.style.left=`${l4}%`; seg4.style.width=`${per[3]}%`;
      p1.textContent=`${Math.round(per[0])}%`; p2.textContent=`${Math.round(per[1])}%`; p3.textContent=`${Math.round(per[2])}%`; p4.textContent=`${Math.round(per[3])}%`;
    }
    async function loadVotesAndRenderResults(forceShow=false){
      if(!currentDeck) return;
      try{
        const { data } = await sb.from("labels").select("bracket").eq("deck_id", currentDeck.id).limit(10000);
        let c1=0,c2=0,c3=0,c4=0;
        for(const r of (data||[])){ if(r.bracket===1)c1++; else if(r.bracket===2)c2++; else if(r.bracket===3)c3++; else if(r.bracket===4)c4++; }
        renderChart(c1,c2,c3,c4);
        if(forceShow) resultsEl.style.display="flex";
      }catch{ if(forceShow) resultsEl.style.display="flex"; }
    }

    const voteChips = Array.from(document.querySelectorAll(".chip[data-vote]"));
    function markMyVote(bracket){
      voteChips.forEach(btn=>{
        const isSel = Number(btn.dataset.vote) === Number(bracket);
        btn.classList.toggle("selected", !!bracket && isSel);
        btn.setAttribute("aria-pressed", String(!!bracket && isSel));
      });
    }
    async function loadMyVote(){
      if(!currentDeck) { markMyVote(null); return null; }
      const { data } = await sb.from("labels").select("bracket").eq("deck_id", currentDeck.id).eq("session_id", sid).maybeSingle();
      const b = data?.bracket ?? null;
      markMyVote(b);
      return b;
    }

    // ãƒ‡ãƒƒã‚­åˆ¥ åå¿œæ™‚é–“ï¼ˆç®¡ç†è€…å‘ã‘ã‚¹ã‚¤ãƒƒãƒã§è¡¨ç¤ºï¼‰
    async function loadDeckRtStat(){
      const box = document.getElementById('deckRtStat');
      if (!SHOW_DECK_STATS) { box.style.display='none'; return; }
      if (!currentDeck) { box.style.display='none'; return; }
      try{
        const { data, error } = await sb.rpc('vote_time_stats_deck', { p_deck: currentDeck.id, p_days: DECK_STATS_DAYS });
        if (error){ box.style.display='none'; return; }
        const row = Array.isArray(data) ? (data[0] || {}) : (data || {});
        const a = Number(row.avg_sec ?? 0).toFixed(2);
        const m = Number(row.median_sec ?? 0).toFixed(2);
        const c = Number(row.cnt ?? 0);
        if (c>0){ box.textContent = `â± éå»${DECK_STATS_DAYS}æ—¥: å¹³å‡ ${a}s / ä¸­å¤® ${m}sï¼ˆ${c}ä»¶ï¼‰`; box.style.display='block'; }
        else { box.style.display='none'; }
      }catch { box.style.display='none'; }
    }

    // ========= è¡¨ç¤º =========
    async function showDeckByRow(row,{showResults=false}={}){
      currentDeck = row;
      markMyVote(null);
      setEmbed(row.source_url);
      const id = toDeckId(row.source_url);
      if (id) history.replaceState(null, "", `${APP_URL}?deck=${id}`);

      const titleA = document.getElementById('deckTitle');
      titleA.textContent = id ? `Hareruya Deck #${id}` : (row.deck_name || "Hareruya Deck");
      titleA.href = row.source_url || '#';

      resultsEl.style.display = showResults ? "flex":"none";
      await loadVotesAndRenderResults(showResults);
      await loadMyVote();
      await loadDeckRtStat();

      clearInterval(autoNextTimer); autoNextTimer=null; autoNextHint.textContent="";
      window._deckShownAt = performance.now();
      lastRtHud.style.display='none';
    }

    // ========= ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆv2ï¼‰ =========
    async function loadRandomDeck(){
      try{
        const { data, error } = await sb.rpc(RPC_RANDOM, { p_session: sid });
        if (error) throw error;
        const row = Array.isArray(data) ? data[0] : data;
        if (row) { await showDeckByRow(row,{showResults:false}); return; }
        const { data: anyDeck } = await sb.from("decks").select("id,source_url,deck_name").order("created_at",{ascending:false}).limit(1);
        const row2 = Array.isArray(anyDeck)? anyDeck[0] : anyDeck;
        if (row2) { await showDeckByRow(row2,{showResults:false}); return; }
        toast("ãƒ‡ãƒƒã‚­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      }catch{ toast("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚"); }
    }

    // ========= æŠ•ç¥¨ï¼ˆ1ãƒ‡ãƒƒã‚­=1XPï¼‰ =========
    let voting = false;
    function setVoting(b){ voting=b; voteChips.forEach(btn => btn.disabled = b); }

    // XPã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ‡ãƒƒã‚­ã®ã¿ï¼‰
    const VOTE_CNT_KEY='mtgb_vote_cnt_v1';                  // è¡¨ç¤ºç”¨ã‚«ã‚¦ãƒ³ã‚¿
    const VOTED_SET_KEY='mtgb_voted_decks_v1';              // æ—¢æŠ•ç¥¨ãƒ‡ãƒƒã‚­é›†åˆ
    function voteCount(){ return Number(localStorage.getItem(VOTE_CNT_KEY)||0); }
    function hasVotedDeck(id){ try{const s=JSON.parse(localStorage.getItem(VOTED_SET_KEY)||'{}'); return !!s[id];}catch{return false} }
    function markVotedDeck(id){
      let s={}; try{s=JSON.parse(localStorage.getItem(VOTED_SET_KEY)||'{}')}catch{s={}}
      if(!s[id]){ s[id]=1; localStorage.setItem(VOTED_SET_KEY, JSON.stringify(s)); localStorage.setItem(VOTE_CNT_KEY, String(voteCount()+1)); }
    }

    // ãƒ¬ãƒ™ãƒ«é–¾å€¤ï¼ˆ0..16ï¼‰: [0,10,30,70,150,310,...å€ã€…]
    const MV_BY_VOTES = [0,10,30,70,150,310,630,1270,2550,5110,10230,20470,40950,81910,163830,327670,655350];
    function mvFromVotes(n){ let mv=0; for(let i=0;i<MV_BY_VOTES.length;i++) if(n>=MV_BY_VOTES[i]) mv=i; return mv; }
    function renderHUD(){
      const n = voteCount();
      const mv = mvFromVotes(n);
      const cur = n - MV_BY_VOTES[mv];
      const nextNeed = (MV_BY_VOTES[mv+1] ?? MV_BY_VOTES[mv]) - MV_BY_VOTES[mv];
      const ratio = nextNeed>0 ? Math.max(0, Math.min(1, cur/nextNeed)) : 1;
      $("#lv").textContent = mv; $("#xp").textContent = n; $("#xpbar").style.width = (ratio*100)+'%';
    }
    renderHUD();

    // ã‚·ãƒ¼ã‚ºãƒ³ï¼ˆæœˆãƒªã‚»ãƒƒãƒˆï¼‰
    const SEASON_KEY='mtgb_season_v1';
    function ensureSeason(){
      const now = new Date(); const season = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      const cur = localStorage.getItem(SEASON_KEY);
      if (cur !== season){ localStorage.removeItem('mtgb_mana_v1'); localStorage.removeItem(VOTE_CNT_KEY); localStorage.removeItem(VOTED_SET_KEY); localStorage.setItem(SEASON_KEY, season); }
    }
    ensureSeason();

    // Mana
    const MANA_KEY='mtgb_mana_v1';
    function getMana(){ try{return JSON.parse(localStorage.getItem(MANA_KEY)||'{"W":0,"U":0,"B":0,"R":0,"G":0,"C":0}')}catch{return {W:0,U:0,B:0,R:0,G:0,C:0}} }
    function setMana(m){ localStorage.setItem(MANA_KEY, JSON.stringify(m)); renderPips(); }
    function renderPips(){ const p=$("#pips"); if(!p) return; const m=getMana(), order=['W','U','B','R','G','C']; p.innerHTML = order.filter(k=>m[k]).map(k=>`<span class="mana ${k}">${k}</span>`).join(''); }
    renderPips();

    function pushLimited(key, value, limit){
      let arr=[]; try{arr=JSON.parse(localStorage.getItem(key)||'[]')}catch{arr=[]}
      arr.push(value); if(arr.length>limit) arr.splice(0, arr.length-limit);
      localStorage.setItem(key, JSON.stringify(arr)); return arr;
    }
    function recordReactionAndTime(){
      const dt = Math.max(0, (performance.now() - (window._deckShownAt || performance.now()))) / 1000;
      pushLimited('mtgb_rt_log_v1', Math.round(dt*10)/10, 20);
      pushLimited('mtgb_dn_log_v1', {h:(new Date()).getHours()}, 60);
      return dt;
    }
    function statsFromLogs(){
      let rts=[], dnl=[];
      try{ rts=JSON.parse(localStorage.getItem('mtgb_rt_log_v1')||'[]') }catch{}
      try{ dnl=JSON.parse(localStorage.getItem('mtgb_dn_log_v1')||'[]') }catch{}
      const avg = rts.length? (rts.reduce((a,b)=>a+b,0)/rts.length) : 999;
      const day = dnl.filter(x=> x.h>=6 && x.h<18).length;
      const night = dnl.filter(x=> (x.h>=18 || x.h<2)).length;
      const total = day + night;
      const dayDominant = total? (day/total) >= 0.55 : false;
      const nightDominant = total? (night/total) >= 0.55 : false;
      const balanced = !dayDominant && !nightDominant;
      return { avg, dayDominant, nightDominant, balanced };
    }
    function isZorome(dtSec){ const t10 = Math.round(dtSec*10); const ones = Math.floor((t10/10)) % 10; const tenths = t10 % 10; return ones>=1 && ones<=9 && ones===tenths; }
    function isZeroEnding(dtSec){ const nearInt = Math.abs(dtSec - Math.round(dtSec)) < 0.25; return nearInt && (Math.round(dtSec) % 10 === 0); }

    // ãƒãƒŠä»˜ä¸ãƒ­ã‚¸ãƒƒã‚¯
    function tryAssignManaOnLevelUpVotes(prevVotes, newVotes, lastDt){
      const prevMV = mvFromVotes(prevVotes);
      const newMV  = mvFromVotes(newVotes);
      if (newMV <= prevMV) return;

      const { avg, dayDominant, nightDominant, balanced } = statsFromLogs();
      let color = 'C';
      if (isZorome(lastDt) || isZeroEnding(lastDt))      color = 'U';
      else if (avg <= 40 && nightDominant)               color = 'R';
      else if (avg >= 80 && dayDominant)                 color = 'G';
      else if (dayDominant)                               color = 'W';
      else if (nightDominant)                             color = 'B';
      else if (balanced)                                  color = 'C';

      const m = getMana();
      if (!m[color]) { m[color] = 1; setMana(m); toast(`ğŸ’  ãƒãƒŠç²å¾—: ${color}ï¼ˆMana ${mvFromVotes(newVotes)}ï¼‰`); }
    }

    async function postVoteOnce(bracket){
      const res = await fetch(FN_VOTE, {
        method: "POST",
        headers: {"Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON,"apikey":SUPABASE_ANON},
        body: JSON.stringify({ deck_id: currentDeck.id, session_id: sid, bracket })
      });
      let ok = res.ok;
      try { const j = await res.clone().json(); if (j && j.ok === false) ok = false; } catch(_){}
      return { ok, status: res.status };
    }
    async function postVoteWithRetry(bracket){
      const retriable = new Set([429,409,500,502,503,504]);
      for (let i=0;i<2;i++){ const { ok, status } = await postVoteOnce(bracket); if (ok) return true; if (!retriable.has(status)) return false; await new Promise(r=>setTimeout(r, 250)); }
      return false;
    }

    document.querySelectorAll(".chip[data-vote]").forEach(el => el.addEventListener("click", async (e)=>{
      if (!currentDeck || voting) return;
      const bracket = Number(e.currentTarget.dataset.vote);

      setVoting(true);
      try{
        const done = await postVoteWithRetry(bracket);
        if (!done){ toast("ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ãŠè©¦ã—ãã ã•ã„ã€‚"); return; }

        const lastDt = recordReactionAndTime();
        lastRtHud.textContent = `${lastDt.toFixed(1)}s`;
        lastRtHud.style.display='inline';

        try { await sb.rpc('add_vote_time', { p_session: sid, p_deck: currentDeck.id, p_ms: Math.round(lastDt * 1000) }); } catch(_){}

        const prevVotes = voteCount();
        const already = hasVotedDeck(currentDeck.id);
        if (!already) markVotedDeck(currentDeck.id); // åˆå›ã ã‘ +1
        const newVotes = voteCount();

        tryAssignManaOnLevelUpVotes(prevVotes, newVotes, lastDt);
        renderHUD();

        markMyVote(bracket);
        resultsEl.style.display="flex";
        await loadVotesAndRenderResults(true);
        await loadDeckRtStat();

        let left = 10;
        autoNextHint.textContent = `${left}ç§’å¾Œã«è‡ªå‹•ã§æ¬¡ã®ãƒ‡ãƒƒã‚­ã¸`;
        clearInterval(autoNextTimer);
        autoNextTimer = setInterval(()=>{
          left--;
          if(left<=0){ clearInterval(autoNextTimer); autoNextTimer=null; loadRandomDeck(); }
          else autoNextHint.textContent = `${left}ç§’å¾Œã«è‡ªå‹•ã§æ¬¡ã®ãƒ‡ãƒƒã‚­ã¸`;
        }, 1000);
      }catch{ toast("ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"); }
      finally{ setVoting(false); }
    }));

    // ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè¨˜éŒ²ã ã‘ã—ã¦æ¬¡ã¸ï¼‰
    async function onSkip(){
      try{ if (currentDeck) await sb.rpc('upsert_skip', { p_session: sid, p_deck: currentDeck.id }); }catch(_){}
      clearInterval(autoNextTimer); autoNextTimer=null; await loadRandomDeck();
    }
    $("#skipBtn").addEventListener("click", onSkip);
    nextBtn.addEventListener("click", ()=> { clearInterval(autoNextTimer); autoNextTimer=null; loadRandomDeck(); });

    // ========= æ¤œç´¢ =========
    async function ensureDeckExists(url){
      const { data } = await sb.from("decks").select("id,source_url,deck_name,registered_at").eq("source_url", url).maybeSingle();
      if(data?.id) return data;
      const res = await fetch(FN_INGEST,{ method:"POST", headers:{ "Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON,"apikey":SUPABASE_ANON }, body: JSON.stringify({ url, session_id:sid }) });
      const j = await res.json().catch(()=> ({}));
      if(res.ok && j.ok){
        const { data: after } = await sb.from("decks").select("id,source_url,deck_name,registered_at").eq("source_url", url).maybeSingle();
        if(after?.id) return after;
      }
      throw new Error(j?.error || "ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
    async function doSearch(){
      const v=$("#searchInput").value.trim(); const url = canonUrl(v);
      if(!url){ toast("URLã¾ãŸã¯æ•°å­—IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      try{ const row = await ensureDeckExists(url); await showDeckByRow(row,{showResults:true}); } catch(e){ toast(String(e.message||e)); }
    }
    $("#searchBtn").addEventListener("click", doSearch);
    $("#searchInput").addEventListener("keydown", e=>{ if(e.key==="Enter") doSearch(); });

    // ========= å…±æœ‰ =========
    function currentDeckLink(){ const id = currentDeck ? toDeckId(currentDeck.source_url) : null; return id ? `${APP_URL}?deck=${id}` : APP_URL; }
    function shareCurrentDeck(){
      const url = currentDeckLink();
      const text = `ã“ã®ãƒ‡ãƒƒã‚­ã®ãƒ–ãƒ©ã‚±ãƒƒãƒˆã¯ï¼Ÿ\n${url}\n#ã¿ã‚“ãªã§ãƒ–ãƒ©ã‚±ãƒƒãƒˆè¨ºæ–­`;
      const tw = new URL("https://x.com/intent/tweet"); tw.searchParams.set("text", text);
      const w = window.open(tw.toString(), "_blank", "noopener,noreferrer"); if (!w) toast("ãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚Xã®æŠ•ç¨¿ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
    }
    document.getElementById("shareBtn").addEventListener("click", shareCurrentDeck);

    // ========= å‰Šé™¤å¸Œæœ›ï¼ˆæˆåŠŸâ†’å°‘ã—å¾…ã£ã¦æ¬¡ã¸ï¼‰ =========
    let reporting = false;
    document.getElementById("reportBtn").addEventListener("click", async ()=>{
      if(!currentDeck || reporting) return;
      reporting = true;
      try{
        const res = await fetch(FN_REPORT,{ method:"POST", headers:{ "Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON,"apikey":SUPABASE_ANON }, body: JSON.stringify({ deck_id: currentDeck.id, session_id: sid, reason:"user_report_from_vote" }) });
        const j = await res.json().catch(()=> ({}));
        if(res.ok && j?.ok!==false){ toast("å ±å‘Šã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚"); clearInterval(autoNextTimer); autoNextTimer=null; setTimeout(()=>{ loadRandomDeck(); reporting=false; }, REPORT_NEXT_DELAY_MS); }
        else { toast("å ±å‘Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); reporting=false; }
      }catch{ toast("å ±å‘Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); reporting=false; }
    });

    // ========= ã‚·ãƒ¼ãƒˆ =========
    const sheet=$("#sheet"), backdrop=$("#backdrop");
    function openSheet(){ sheet.style.display="flex"; backdrop.style.display="block"; }
    function closeSheet(){ sheet.style.display="none"; backdrop.style.display="none"; }
    $("#openSheet").addEventListener("click", openSheet);
    $("#closeSheet").addEventListener("click", closeSheet);
    backdrop.addEventListener("click", closeSheet);

    // ã‚¿ãƒ–
    const tabs = document.querySelectorAll(".tab");
    tabs.forEach(t=> t.addEventListener("click", ()=>{
      tabs.forEach(x=>x.classList.remove("active")); t.classList.add("active");
      const name=t.dataset.tab;
      $("#pane-reg").style.display = name==="reg" ? "block":"none";
      $("#pane-del").style.display = name==="del" ? "block":"none";
      $("#pane-mine").style.display= name==="mine"? "block":"none";
      if(name==="mine") loadMine();
    }));

    // ç™»éŒ²ï¼ˆä¸Šé™100ï¼‰
    $("#regBtn").addEventListener("click", async ()=>{
      const msg=$("#regMsg"); msg.textContent="";
      const v=$("#regUrl").value.trim(); const url=canonUrl(v); if(!url){ msg.textContent="URLå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }
      // ä¸Šé™ãƒã‚§ãƒƒã‚¯
      const { count } = await sb.from("decks").select("id", { count: "exact", head: true }).eq("created_by_session", sid);
      if ((count ?? 0) >= 100){ msg.textContent="ç™»éŒ²ä¸Šé™ï¼ˆ100ä»¶ï¼‰ã«é”ã—ã¦ã„ã¾ã™ã€‚"; return; }
      msg.textContent="ç™»éŒ²ä¸­...";
      try{
        const res = await fetch(FN_INGEST,{ method:"POST", headers:{ "Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON,"apikey":SUPABASE_ANON }, body: JSON.stringify({ url, session_id:sid }) });
        const j = await res.json().catch(()=> ({}));
        if(res.ok && j.ok){ msg.textContent = "ç™»éŒ²ã—ã¾ã—ãŸã€‚"; try{ const row = await ensureDeckExists(url); await showDeckByRow(row,{showResults:false}); }catch{} loadMine(); }
        else{ msg.textContent = `ç™»éŒ²å¤±æ•—: ${j?.error || res.statusText}`; }
      }catch{ msg.textContent="ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"; }
    });

    // é€šå ±ã‚¿ãƒ–
    $("#delBtn").addEventListener("click", async ()=>{
      const msg=$("#delMsg"); msg.textContent="";
      const v=$("#delUrl").value.trim(); const url=canonUrl(v); if(!url){ msg.textContent="URLå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }
      const { data } = await sb.from("decks").select("id").eq("source_url", url).maybeSingle();
      if(!data?.id){ msg.textContent="ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"; return; }
      try{
        const res = await fetch(FN_REPORT,{ method:"POST", headers:{ "Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON,"apikey":SUPABASE_ANON }, body: JSON.stringify({ deck_id: data.id, session_id: sid, reason:"user_delete_request" }) });
        const j = await res.json().catch(()=> ({}));
        (res.ok && j?.ok!==false) ? (msg.textContent="å ±å‘Šã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚") : (msg.textContent=`å ±å‘Šã«å¤±æ•—ã—ã¾ã—ãŸ: ${j?.error || res.statusText}`);
      }catch{ msg.textContent="å ±å‘Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; }
    });

    // è‡ªåˆ†ã®ç™»éŒ²ï¼ˆæ•°å­—ã ã‘ & ãƒŸãƒ‹ã‚°ãƒ©ãƒ•ï¼‰
    $("#reloadMine").addEventListener("click", ()=> loadMine());
    async function loadMiniChart(deckId, container){
      const { data, error } = await sb.from("labels").select("bracket").eq("deck_id", deckId).limit(5000);
      if(error){ container.textContent="â€“"; return; }
      let c=[0,0,0,0]; for(const r of (data||[])) if(r.bracket>=1 && r.bracket<=4) c[r.bracket-1]++;
      const total=c.reduce((a,b)=>a+b,0) || 1;
      const per=c.map(x=> Math.round(x/total*100));
      const bar=document.createElement("div"); bar.className="miniBar";
      const s1=document.createElement("div"), s2=document.createElement("div"), s3=document.createElement("div"), s4=document.createElement("div");
      [s1,s2,s3,s4].forEach((s,i)=>{ s.className=`miniSeg b${i+1}`; bar.appendChild(s); });
      s1.style.left="0%"; s1.style.width = per[0]+"%";
      s2.style.left= per[0]+"%"; s2.style.width = per[1]+"%";
      s3.style.left=(per[0]+per[1])+"%"; s3.style.width = per[2]+"%";
      s4.style.left=(per[0]+per[1]+per[2])+"%"; s4.style.width = per[3]+"%";
      const overlay=document.createElement("div"); overlay.className="miniOverlay"; overlay.textContent=`1:${per[0]}%  2:${per[1]}%  3:${per[2]}%  4:${per[3]}%  (n=${total})`;
      container.innerHTML=""; container.append(bar, overlay);
      container.addEventListener('touchstart', ()=>{ overlay.style.display='block'; setTimeout(()=> overlay.style.display='none', 1200); }, {passive:true});
    }
    async function loadMine(){
      const listEl=$("#mineList");
      listEl.innerHTML="èª­ã¿è¾¼ã¿ä¸­â€¦";
      const { data, error } = await sb.from("decks").select("id,source_url,deck_name,created_at").eq("created_by_session", sid).order("created_at",{ascending:false}).limit(50);
      if(error){ listEl.textContent="èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼"; return; }
      if(!data || data.length===0){ listEl.textContent="ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }
      listEl.innerHTML="";
      for(const d of data){
        const id = toDeckId(d.source_url) || (d.source_url||"").split("/").pop();
        const item=document.createElement("div"); item.className="item";
        const a=document.createElement("a"); a.href=d.source_url; a.target="_blank"; a.rel="noopener noreferrer";
        a.textContent = id || d.source_url; // â† æ•°å­—ã ã‘
        const mini=document.createElement("div"); mini.className="mini"; await loadMiniChart(d.id, mini);
        const del=document.createElement("button"); del.className="small-btn"; del.textContent="å‰Šé™¤";
        del.addEventListener("click", ()=> deleteOwn(d.id, item));
        const show=document.createElement("button"); show.className="small-btn"; show.textContent="è¡¨ç¤º";
        show.addEventListener("click", async ()=> {
          const row = await sb.from("decks").select("id,source_url,deck_name,registered_at").eq("id", d.id).maybeSingle();
          if(row.data) await showDeckByRow(row.data,{showResults:false}); closeSheet();
        });
        item.append(a, mini, show, del); listEl.appendChild(item);
      }
    }
    async function deleteOwn(deck_id, node){
      if(!confirm("ã“ã®ç™»éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆæŠ•ç¥¨/é€šå ±ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰")) return;
      try{
        const res = await fetch(FN_DELETE_OWN,{ method:"POST", headers:{ "Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON,"apikey":SUPABASE_ANON }, body: JSON.stringify({ deck_id, session_id: sid }) });
        const j = await res.json().catch(()=> ({}));
        if(res.ok && j?.ok){ toast("å‰Šé™¤ã—ã¾ã—ãŸ"); node?.remove(); if(currentDeck?.id===deck_id) loadRandomDeck(); }
        else toast(`å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${j?.error || res.statusText}`);
      }catch{ toast("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
    }

    // ======= èµ·å‹•æ™‚ =======
    const paramDeck = new URLSearchParams(location.search).get("deck");
    if (paramDeck) {
      const url = canonUrl(paramDeck);
      if (url) {
        try { const row = await ensureDeckExists(url); await showDeckByRow(row, { showResults: true }); }
        catch { await loadRandomDeck(); }
      } else { await loadRandomDeck(); }
    } else { await loadRandomDeck(); }
  </script>
</body>
</html>
