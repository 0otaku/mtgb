<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>管理 | みんなでブラケット診断</title>
<meta name="robots" content="noindex, nofollow">
<style>
  body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;padding:16px;background:#fff;color:#0f172a}
  h2{margin:18px 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
  button{cursor:pointer;background:#fff}
  .grid{display:grid;gap:10px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .muted{color:#64748b;font-size:12px}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  .danger{background:#dc2626;color:#fff;border-color:#dc2626}
  .warn{background:#f59e0b;color:#111827;border-color:#f59e0b}
  .ok{background:#16a34a;color:#fff;border-color:#16a34a}
  .link{color:#2563eb;text-decoration:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .section{margin-top:16px}
  /* ▼ ページ内スクロール（固定高） */
  .scrollbox{max-height:60vh;overflow:auto;padding-right:4px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  #dlist{ max-height:420px; overflow:auto }
  @media(max-width:900px){ .two-col{grid-template-columns:1fr} }
</style>

<body>
  <div class="row">
    <b>管理</b>
    <label>Admin Token: <input id="token" placeholder="保存されます" style="min-width:260px"></label>
  </div>

  <!-- ▼ 設定（通報しきい値） -->
  <div class="section">
    <h2>設定</h2>
    <div class="row">
      <label>通報しきい値 <input id="th" type="number" value="5" style="width:90px"></label>
      <button id="loadSet">読み込み</button>
      <button id="saveSet" class="ok">保存</button>
    </div>
    <div class="muted">※ この件数以上の通報で該当デッキを自動削除します</div>
  </div>
  <!-- ▲ 設定 -->

  <!-- ▼ アナリティクス（Edge Function不要・フロントで集計） -->
  <div class="section">
    <h2>アナリティクス</h2>

    <div class="card">
      <div class="row">
        <b>全体 反応時間</b>
        <label>過去 <input id="rt_days" type="number" value="7" style="width:90px"></label> 日
        <button id="rt_load">読み込み</button>
      </div>
      <div id="rt_out" class="muted" style="margin-top:6px">—</div>
    </div>

    <div class="two-col">
      <div class="card">
        <div class="row">
          <b>デッキ別反応</b>
          <label>過去 <input id="rt_d_days" type="number" value="7" style="width:90px"></label> 日</label>
          <label>件数 <input id="rt_d_limit" type="number" value="50" style="width:90px"></label>
          <label>並び <select id="rt_d_sort">
            <option value="avg_desc">平均(遅い順)</option>
            <option value="avg_asc">平均(速い順)</option>
            <option value="med_desc">中央値(遅い順)</option>
            <option value="med_asc">中央値(速い順)</option>
            <option value="cnt_desc">件数(多い順)</option>
            <option value="cnt_asc">件数(少ない順)</option>
          </select></label>
          <button id="rt_d_load">読み込み</button>
        </div>
        <div id="rt_d_list" class="scrollbox" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <div class="row">
          <b>アクセス（日別）</b>
          <label>過去 <input id="traf_days" type="number" value="7" style="width:90px"></label> 日</label>
          <button id="traf_load">読み込み</button>
        </div>
        <div id="traf_out" class="scrollbox" style="margin-top:6px"></div>
        <div class="muted" style="margin-top:6px">※ impressions テーブルが無い場合は空になります</div>
      </div>
    </div>
  </div>
  <!-- ▲ アナリティクス -->

  <!-- ▼ デッキ一覧（ページ内スクロール） -->
  <div class="section">
    <h2>デッキ一覧</h2>
    <div class="row">
      <label>検索 <input id="dq" placeholder="URL/名前"></label>
      <label>件数 <input id="dlimit" type="number" value="50" style="width:90px"></label>
      <label>From <input id="dfrom" type="date"></label>
      <label>To <input id="dto" type="date"></label>
      <label>Offset <input id="doffset" type="number" value="0" style="width:90px"></label>
      <button id="dload">読み込み</button>
    </div>
    <div id="dlist" class="grid scrollbox"></div>
  </div>
  <!-- ▲ デッキ一覧 -->

  <!-- ▼ 通報一覧 -->
  <div class="section">
    <h2>通報一覧</h2>
    <div class="row">
      <label>検索 <input id="q" placeholder="URL/名前"></label>
      <label>最小通報数 <input id="min" type="number" value="1" style="width:90px"></label>
      <label>件数 <input id="limit" type="number" value="50" style="width:90px"></label>
      <label>From <input id="from" type="date"></label>
      <label>To <input id="to" type="date"></label>
      <button id="load">読み込み</button>
    </div>
    <div id="list" class="grid scrollbox"></div>
  </div>

  <!-- ▼ 上位者 -->
  <div class="section">
    <h2>通報者（上位）</h2>
    <div class="row">
      <label>過去 <input id="days" type="number" value="7" style="width:90px"></label> 日間
      <label>件数 <input id="limit_rep" type="number" value="100" style="width:90px"></label>
      <button id="loadRep">読み込み</button>
    </div>
    <div id="reporters" class="grid scrollbox"></div>
  </div>

  <div class="section">
    <h2>登録者（上位）</h2>
    <div class="row">
      <label>過去 <input id="days_reg" type="number" value="7" style="width:90px"></label> 日間
      <label>件数 <input id="limit_reg" type="number" value="100" style="width:90px"></label>
      <button id="loadReg">読み込み</button>
    </div>
    <div id="registrants" class="grid scrollbox"></div>
  </div>

  <div class="section">
    <h2>ブロック一覧</h2>
    <div class="row"><button id="loadBL">更新</button></div>
    <div class="grid scrollbox" id="blocklist"></div>
  </div>

<!-- ========= Supabase クライアント（moduleでwindowへ） ========= -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const SUPABASE_URL  = "https://onzljxnqlrohkzsfxqbh.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uemxqeG5xbHJvaGt6c2Z4cWJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUzNTksImV4cCI6MjA3MTE1MTM1OX0.eLAP_-PtVm6tBFFCNfOVsTqEcvtZK3x3QFFNeRpxuj8";
  window.sb = createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: { persistSession:false, autoRefreshToken:false },
    global: { headers: { apikey: SUPABASE_ANON } },
  });
</script>

<script>
/* ==== 既存の admin2 API ==== */
const FN = "https://onzljxnqlrohkzsfxqbh.supabase.co/functions/v1/admin2";
const $ = (id)=>document.getElementById(id);
$("token").value = localStorage.getItem("admin_token") || "";
$("token").addEventListener('change',()=>localStorage.setItem("admin_token",$("token").value));

/* ==== ボタン紐付け ==== */
$("loadSet").onclick = loadSettings;
$("saveSet").onclick = saveSettings;
$("dload").onclick = loadDecks;
$("load").onclick = loadReports;
$("loadRep").onclick = loadReporters;
$("loadReg").onclick = loadRegistrants;
$("loadBL").onclick = loadBlocklist;

/* ==== アナリティクス紐付け（フロント集計） ==== */
$("rt_load").onclick = calcGlobalRT;
$("rt_d_load").onclick = calcDeckRT;
$("traf_load").onclick = calcTraffic;

/* ==== 共通 API ヘルパ ==== */
async function api(pathOrQuery, opts={}){
  const token=$("token").value.trim(); if(!token){ alert("Admin Tokenを入力してください"); throw new Error('no token'); }
  const url = pathOrQuery.startsWith("http") ? pathOrQuery : `${FN}${pathOrQuery}`;
  const r = await fetch(url, { ...opts, headers: { ...(opts.headers||{}), "x-admin-token": token } });
  if(!r.ok){
    const t = await r.text().catch(()=> "");
    throw new Error(t || `HTTP ${r.status}`);
  }
  return r.json();
}
async function apiPost(payload){ return api("", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) }); }

/* ==== 設定（取得・保存） ==== */
async function loadSettings(){
  try{
    const j = await api("?view=settings", { method:"GET" });
    $("th").value = j?.data?.report_delete_threshold?.value ?? 5;
  }catch(e){ alert("設定の読み込みに失敗: " + (e?.message||e)); }
}
async function saveSettings(){
  const v = Number($("th").value || "5");
  if (!Number.isFinite(v) || v<1) return alert("1以上の数値を入力してください");
  try{
    await api("", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ action:"set_settings", report_delete_threshold: v }) });
    alert("保存しました");
  }catch(e){ alert("保存に失敗: " + (e?.message||e)); }
}

/* ==== デッキ一覧（ページ内スクロール対応） ==== */
async function loadDecks(){
  const q = $("dq").value.trim();
  const limit = $("dlimit").value || "50";
  const from = $("dfrom").value;
  const to   = $("dto").value;
  const offset = $("doffset").value || "0";
  const query = `?view=decks&limit=${encodeURIComponent(limit)}&offset=${encodeURIComponent(offset)}${from?`&from=${from}`:''}${to?`&to=${to}`:''}${q?`&q=${encodeURIComponent(q)}`:''}`;

  try{
    const j = await api(query, { method:"GET" });
    const L = $("dlist");
    const fmt = (d)=> d ? new Date(d).toLocaleString() : "—";
    L.innerHTML = (j.data||[]).map(x=>`
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <div>
            <div><b>${x.deck_name || '(名称なし)'}</b></div>
            <div class="muted">登録: ${fmt(x.created_at)} / 公開日: ${x.registered_at||'—'} / 通報: ${x.report_count||0}件</div>
            <div class="muted">votes: [1:${x.votes?.b1||0}] [2:${x.votes?.b2||0}] [3:${x.votes?.b3||0}] [4:${x.votes?.b4||0}]</div>
            <div><a class="link mono" href="${x.source_url}" target="_blank" rel="noopener">${x.source_url}</a></div>
            <div class="muted">IP: <span class="mono">${x.created_by_ip||'-'}</span> / SID: <span class="mono">${x.created_by_session||'-'}</span></div>
          </div>
          <div class="btns">
            <button class="danger" onclick="delDeck('${x.id}')" title="ラベル/通報も削除">削除</button>
          </div>
        </div>
      </div>
    `).join('') || '<div class="muted">該当なし</div>';
  }catch(e){
    alert("読み込みに失敗しました: " + (e?.message||e));
  }
}

/* ==== 通報一覧 ==== */
async function loadReports(){
  const q = $("q").value.trim();
  const min = $("min").value || "1";
  const limit = $("limit").value || "50";
  const from = $("from").value;
  const to   = $("to").value;
  const query = `?view=reports&min=${encodeURIComponent(min)}&limit=${encodeURIComponent(limit)}${from?`&from=${from}`:''}${to?`&to=${to}`:''}${q?`&q=${encodeURIComponent(q)}`:''}`;
  const j = await api(query, { method: "GET" });
  const list = $("list");
  const fmt = (d)=>new Date(d).toLocaleString();
  list.innerHTML = (j.data||[]).map(x=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div>
          <div><b>${x.deck_name || '(名称なし)'}</b></div>
          <div class="muted">通報: ${x.report_count}件 / 最終: ${fmt(x.latest_reported_at)} / 登録日: ${x.registered_at||'—'}</div>
          <div><a class="link mono" href="${x.deck_source_url}" target="_blank" rel="noopener">${x.deck_source_url}</a></div>
        </div>
        <div class="btns">
          <button class="warn" onclick="clearReports('${x.deck_id}')">通報クリア</button>
          <button class="danger" onclick="delDeck('${x.deck_id}')" title="ラベルも含め削除されます">削除</button>
        </div>
      </div>
    </div>
  `).join('') || '<div class="muted">該当なし</div>';
}

/* ==== 削除・通報クリア ==== */
async function delDeck(id){
  if(!confirm("このデッキを削除しますか？（投票・通報も消えます）")) return;
  await apiPost({ action:"delete_deck", deck_id:id });
  loadDecks(); loadReports();
}
async function clearReports(id){
  if(!confirm("このデッキの通報を全て削除しますか？")) return;
  await apiPost({ action:"clear_reports", deck_id:id });
  loadReports();
}

/* ==== 通報者（上位） ==== */
async function loadReporters(){
  const limit = $("limit_rep").value || "100";
  const days = $("days").value || "7";
  const j = await api(`?view=reporters&limit=${encodeURIComponent(limit)}&days=${encodeURIComponent(days)}`, { method:"GET" });
  const L = $("reporters");
  const fmt = (d)=>new Date(d).toLocaleString();
  L.innerHTML = (j.data||[]).map(r=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div>
          <div>IP: <span class="mono">${r.ip || '-'}</span> / Session: <span class="mono">${r.session_id || '-'}</span></div>
          <div class="muted">通報: ${r.count}件 / 最終: ${fmt(r.last)}</div>
        </div>
        <div class="btns">
          ${r.ip ? (r.blocked_ip
            ? `<button class="ok" onclick="unblockIp('${r.ip}')">IP解除</button>`
            : `<button class="danger" onclick="blockIp('${r.ip}')">IPブロック</button>`) : ''}
          ${r.session_id ? (r.blocked_session
            ? `<button class="ok" onclick="unblockSession('${r.session_id}')">セッション解除</button>`
            : `<button class="danger" onclick="blockSession('${r.session_id}')">セッションブロック</button>`) : ''}
        </div>
      </div>
    </div>
  `).join('') || '<div class="muted">該当なし</div>';
}

/* ==== 登録者（上位） ==== */
async function loadRegistrants(){
  const limit = $("limit_reg").value || "100";
  const days = $("days_reg").value || "7";
  const j = await api(`?view=registrants&limit=${encodeURIComponent(limit)}&days=${encodeURIComponent(days)}`, { method:"GET" });
  const L = $("registrants");
  const fmt = (d)=>new Date(d).toLocaleString();
  L.innerHTML = (j.data||[]).map(r=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div>
          <div>IP: <span class="mono">${r.ip || '-'}</span> / Session: <span class="mono">${r.session_id || '-'}</span></div>
          <div class="muted">登録: ${r.count}件 / 最終: ${fmt(r.last)}</div>
        </div>
        <div class="btns">
          ${r.ip ? (r.blocked_ip
            ? `<button class="ok" onclick="unblockIp('${r.ip}')">IP解除</button>`
            : `<button class="danger" onclick="blockIp('${r.ip}')">IPブロック</button>`) : ''}
          ${r.session_id ? (r.blocked_session
            ? `<button class="ok" onclick="unblockSession('${r.session_id}')">セッション解除</button>`
            : `<button class="danger" onclick="blockSession('${r.session_id}')">セッションブロック</button>`) : ''}
        </div>
      </div>
    </div>
  `).join('') || '<div class="muted">該当なし</div>';
}

/* ==== ブロック操作＆一覧 ==== */
async function blockIp(ip){ await apiPost({ action:"block_ip", ip }); loadReporters(); loadRegistrants(); loadBlocklist(); }
async function unblockIp(ip){ await apiPost({ action:"unblock_ip", ip }); loadReporters(); loadRegistrants(); loadBlocklist(); }
async function blockSession(session_id){ await apiPost({ action:"block_session", session_id }); loadReporters(); loadRegistrants(); loadBlocklist(); }
async function unblockSession(session_id){ await apiPost({ action:"unblock_session", session_id }); loadReporters(); loadRegistrants(); loadBlocklist(); }

async function loadBlocklist(){
  const j = await api(`?view=blocklist`, { method:"GET" });
  const B = $("blocklist");
  B.innerHTML = `
    <div class="card">
      <div><b>IP</b></div>
      ${(j.ips||[]).map(x=>`
        <div class="row" style="justify-content:space-between">
          <span class="mono">${x.ip}</span>
          <div class="btns"><button class="ok" onclick="unblockIp('${x.ip}')">解除</button></div>
        </div>
      `).join('') || '<div class="muted">なし</div>'}
    </div>
    <div class="card">
      <div><b>セッション</b></div>
      ${(j.sessions||[]).map(x=>`
        <div class="row" style="justify-content:space-between">
          <span class="mono">${x.session_id}</span>
          <div class="btns"><button class="ok" onclick="unblockSession('${x.session_id}')">解除</button></div>
        </div>
      `).join('') || '<div class="muted">なし</div>'}
    </div>
  `;
}

/* ====== アナリティクス実装（Supabase直読） ====== */

function median(arr){
  if(!arr.length) return 0;
  const a = [...arr].sort((x,y)=>x-y);
  const m = Math.floor(a.length/2);
  return a.length%2 ? a[m] : (a[m-1]+a[m])/2;
}

async function calcGlobalRT(){
  const days = Number($("rt_days").value || "7");
  const since = new Date(Date.now() - days*24*60*60*1000).toISOString();
  const { data, error } = await window.sb
    .from("labels")
    .select("rt_sec,created_at", { count:"exact" })
    .gte("created_at", since)
    .not("rt_sec","is", null)
    .limit(10000);
  if(error){ $("rt_out").textContent = "読み込みエラー: " + error.message; return; }
  const secs = (data||[]).map(r=>Number(r.rt_sec)||0).filter(n=>Number.isFinite(n)&&n>=0);
  const avg = secs.length ? (secs.reduce((a,b)=>a+b,0)/secs.length) : 0;
  const med = median(secs);
  $("rt_out").textContent = `平均 ${avg.toFixed(2)}s / 中央 ${med.toFixed(2)}s（件数: ${secs.length}、過去${days}日）`;
}

async function calcDeckRT(){
  const days = Number($("rt_d_days").value || "7");
  const limit = Number($("rt_d_limit").value || "50");
  const sort = $("rt_d_sort").value;
  const since = new Date(Date.now() - days*24*60*60*1000).toISOString();
  const { data, error } = await window.sb
    .from("labels")
    .select("rt_sec,created_at,deck_id")
    .gte("created_at", since)
    .not("rt_sec","is", null)
    .limit(10000);
  if(error){ $("rt_d_list").innerHTML = `<div class="muted">読み込みエラー: ${error.message}</div>`; return; }
  const byDeck = new Map();
  for(const r of (data||[])){
    const d = String(r.deck_id);
    const s = Number(r.rt_sec)||0;
    if(!Number.isFinite(s)||s<0) continue;
    const arr = byDeck.get(d) || []; arr.push(s); byDeck.set(d, arr);
  }
  const rows = [];
  for(const [deck_id, arr] of byDeck){
    const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
    const med = median(arr);
    rows.push({ deck_id, avg, med, cnt: arr.length });
  }
  const cmp = {
    avg_desc:(a,b)=>b.avg-a.avg, avg_asc:(a,b)=>a.avg-b.avg,
    med_desc:(a,b)=>b.med-a.med, med_asc:(a,b)=>a.med-b.med,
    cnt_desc:(a,b)=>b.cnt-a.cnt, cnt_asc:(a,b)=>a.cnt-b.cnt
  }[sort] || ((a,b)=>b.cnt-a.cnt);
  rows.sort(cmp);
  const top = rows.slice(0, limit);

  // deckのURL/名前を取得（必要数だけ）
  const ids = top.map(r=>r.deck_id);
  let decks = new Map();
  if(ids.length){
    const { data: dd } = await window.sb.from("decks").select("id,source_url,deck_name").in("id", ids);
    for(const d of (dd||[])) decks.set(String(d.id), d);
  }

  $("rt_d_list").innerHTML = top.map(r=>{
    const d = decks.get(r.deck_id);
    const url = d?.source_url || "";
    return `
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <div>
            <div><b>${d?.deck_name || '(名称なし)'}</b></div>
            <div class="muted">平均 ${r.avg.toFixed(2)}s / 中央 ${r.med.toFixed(2)}s / 件数 ${r.cnt}</div>
            ${url ? `<div><a class="link mono" href="${url}" target="_blank" rel="noopener">${url}</a></div>` : ''}
          </div>
        </div>
      </div>`;
  }).join('') || '<div class="muted">該当なし</div>';
}

async function calcTraffic(){
  const days = Number($("traf_days").value || "7");
  const since = new Date(Date.now() - days*24*60*60*1000).toISOString();
  // impressions が無い場合に備えて try
  const { data, error } = await window.sb
    .from("impressions")
    .select("created_at")
    .gte("created_at", since)
    .limit(20000);
  if(error){ $("traf_out").innerHTML = `<div class="muted">impressions未作成かRLSで不可: ${error.message}</div>`; return; }
  const byDay = new Map();
  for(const r of (data||[])){
    const d = new Date(r.created_at);
    const k = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
    byDay.set(k, (byDay.get(k)||0)+1);
  }
  const rows = [...byDay.entries()].sort((a,b)=>a[0]<b[0]?1:-1);
  $("traf_out").innerHTML = rows.map(([day,cnt])=>`
    <div class="row" style="justify-content:space-between">
      <div>${day}</div><div class="mono">${cnt}</div>
    </div>
  `).join('') || '<div class="muted">該当なし</div>';
}

/* 初期：設定だけ自動読込（不要なら削除OK） */
loadSettings();
</script>
</body>
</html>
