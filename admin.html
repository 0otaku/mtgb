<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>管理 | みんなでブラケット診断</title>
<meta name="robots" content="noindex, nofollow">
<style>
  body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;padding:16px;background:#fff;color:#0f172a}
  h1{margin:0 0 12px;font-size:18px}
  h2{margin:18px 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,select,textarea{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;font:inherit}
  textarea{width:100%;min-height:120px;resize:vertical;line-height:1.5}
  button{cursor:pointer;background:#fff}
  .grid{display:grid;gap:10px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff}
  .muted{color:#64748b;font-size:12px}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  .danger{background:#dc2626;color:#fff;border-color:#dc2626}
  .warn{background:#f59e0b;color:#111827;border-color:#f59e0b}
  .ok{background:#16a34a;color:#fff;border-color:#16a34a}
  .link{color:#2563eb;text-decoration:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
  .section{margin-top:16px}
  .close-btn{margin-left:auto}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi .box{border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;min-width:120px}
  .kpi .box b{font-size:18px}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;font-size:12px;background:#fff}
  .chip .x{cursor:pointer;opacity:.7}
  .chip .x:hover{opacity:1}
  #banner{display:none;margin:8px 0 0;padding:8px 12px;border-radius:8px;background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12}
</style>
<body>
  <div class="row">
    <h1>管理</h1>
    <label>Admin Token: <input id="token" placeholder="保存されます" style="min-width:320px"></label>
  </div>
  <div id="banner"></div>

  <!-- ====== 1) 通報一覧 ====== -->
  <details class="section" open>
    <summary><h2>通報一覧</h2></summary>
    <div class="row">
      <label>検索 <input id="q" placeholder="URL/名前/ID"></label>
      <label>最小通報数 <input id="min" type="number" value="1" style="width:90px"></label>
      <label>件数 <input id="limit" type="number" value="50" style="width:90px"></label>
      <label>From <input id="from" type="date"></label>
      <label>To <input id="to" type="date"></label>
      <button id="btnLoadReports">読み込み</button>
      <button class="close-btn" data-close>閉じる</button>
    </div>
    <div id="reportList" class="grid"></div>
  </details>

  <!-- ====== 2) 通報しきい値（※XP/マナは別） ====== -->
  <details class="section" open>
    <summary><h2>通報しきい値</h2></summary>
    <div class="row">
      <label>通報しきい値 <input id="th" type="number" value="5" style="width:90px"></label>
      <button id="btnLoadSet">読み込み</button>
      <button id="btnSaveSet" class="ok">保存</button>
      <button class="close-btn" data-close>閉じる</button>
    </div>
    <div class="muted">※ <code>app_settings</code> の <code>report_delete_threshold</code> を読み書き</div>
  </details>

  <!-- ====== 3) 復旧一覧 ====== -->
  <details class="section" open>
    <summary><h2>復旧一覧（自動/手動削除ログ）</h2></summary>
    <div class="row">
      <label>過去 <input id="days_del" type="number" value="30" style="width:90px"></label> 日間
      <label>件数 <input id="limit_del" type="number" value="100" style="width:90px"></label>
      <button id="btnLoadDel">読み込み</button>
      <button class="close-btn" data-close>閉じる</button>
    </div>
    <div id="deletedList" class="grid"></div>
  </details>

  <!-- ====== 4) スパイク検知 ====== -->
  <details class="section" open>
    <summary><h2>スパイク検知（直近N時間）</h2></summary>
    <div class="row">
      <label>時間 <input id="hours_sp" type="number" value="24" style="width:90px"></label>
      <button id="btnLoadSpikes">読み込み</button>
      <button class="close-btn" data-close>閉じる</button>
    </div>
    <div id="spikeList" class="grid"></div>
  </details>

  <!-- ====== 5) 保留削除 ====== -->
  <details class="section" open>
    <summary><h2>保留削除（スケジュール）</h2></summary>
    <div class="row">
      <button id="btnLoadPending">読み込み</button>
      <button class="close-btn" data-close>閉じる</button>
    </div>
    <div id="pendingList" class="grid"></div>
  </details>

  <!-- ====== 6) サマリー / 人気 ====== -->
  <details class="section" open>
    <summary><h2>サマリー / 人気デッキ</h2></summary>
    <div class="card">
      <div class="row">
        <label>過去 <input id="days_sum" type="number" value="7" style="width:90px"></label> 日
        <button id="btnLoadSummary">サマリー読み込み</button>
        <button class="close-btn" data-close>閉じる</button>
      </div>
      <div id="sumBox" class="kpi" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <div class="row">
        <label>過去 <input id="days_pop" type="number" value="7" style="width:90px"></label> 日
        <label>件数 <input id="limit_pop" type="number" value="20" style="width:90px"></label>
        <button id="btnLoadPop">人気デッキ 読み込み</button>
        <button class="close-btn" data-close>閉じる</button>
      </div>
      <div id="popBox" class="grid"></div>
    </div>
  </details>

  <!-- ====== 7) アナリティクス ====== -->
  <details class="section" open>
    <summary><h2>アナリティクス</h2></summary>
    <div class="card">
      <div class="row">
        <label>過去 <input id="days_rt" type="number" value="7" style="width:90px"></label> 日
        <button id="btnLoadRT">反応速度 読み込み</button>
        <button class="close-btn" data-close>閉じる</button>
      </div>
      <div id="rtBox" class="grid"></div>
    </div>
    <div class="card">
      <div class="row">
        <label>過去 <input id="days_imp" type="number" value="7" style="width:90px"></label> 日
        <label><select id="grain"><option value="hour">時間</option><option value="day">日</option></select></label>
        <button id="btnLoadImp">アクセス数 読み込み</button>
        <button class="close-btn" data-close>閉じる</button>
      </div>
      <div id="impBox" class="grid"></div>
    </div>
    <div class="card">
      <div class="row">
        <label>過去 <input id="days_vbd" type="number" value="7" style="width:90px"></label> 日
        <label>件数 <input id="vbd_limit" type="number" value="100" style="width:90px"></label>
        <button id="btnLoadVBD">デッキ別投票数 読み込み</button>
        <button class="close-btn" data-close>閉じる</button>
      </div>
      <div id="vbdBox" class="grid"></div>
    </div>
  </details>

  <!-- ====== 8) 理由トップ ====== -->
  <details class="section" open>
    <summary><h2>理由トップ（全体 / デッキ別）</h2></summary>
    <div class="row">
      <label>過去 <input id="days_reason" type="number" value="7" style="width:90px"></label> 日間
      <label>deck_id <input id="deck_reason" placeholder="（任意）uuid" style="min-width:320px"></label>
      <button id="btnLoadReasonTop">読み込み</button>
      <button class="close-btn" data-close>閉じる</button>
    </div>
    <div id="reasonTop" class="grid"></div>
    <div class="muted">※ admin2 の <code>reasons_top</code> を使用（5秒フィルタ仕様のまま）</div>
  </details>

  <!-- ====== 9) 登録者（上位） ====== -->
  <details class="section" open>
    <summary><h2>登録者（上位）</h2></summary>
    <div class="row">
      <label>過去 <input id="days_reg" type="number" value="7" style="width:90px"></label> 日間
      <label>件数 <input id="limit_reg" type="number" value="100" style="width:90px"></label>
      <button id="btnLoadReg">読み込み</button>
      <button class="close-btn" data-close>閉じる</button>
    </div>
    <div id="registrants" class="grid"></div>
  </details>

  <!-- ====== 10) 通報者（上位） ====== -->
  <details class="section" open>
    <summary><h2>通報者（上位）</h2></summary>
    <div class="row">
      <label>過去 <input id="days_rep" type="number" value="7" style="width:90px"></label> 日間
      <label>件数 <input id="limit_rep" type="number" value="100" style="width:90px"></label>
      <button id="btnLoadRep">読み込み</button>
      <button class="close-btn" data-close>閉じる</button>
    </div>
    <div id="reporters" class="grid"></div>
  </details>

  <!-- ====== 11) ブロック一覧 ====== -->
  <details class="section" open>
    <summary><h2>ブロック一覧</h2></summary>
    <div class="row">
      <button id="btnLoadBL">読み込み</button>
      <button class="close-btn" data-close>閉じる</button>
    </div>
    <div class="grid" id="blocklist"></div>
  </details>

  <!-- ====== 12) マスター編集 ====== -->
  <details class="section" open>
    <summary><h2>マスター編集（テーマ / タグ / 投票理由）</h2></summary>
    <div class="card">
      <h3>テーマ（1択）</h3>
      <div class="row">
        <input id="themeInput" placeholder="例: コンボ" style="flex:1">
        <button id="themeAdd">追加</button>
        <button id="btnLoadMasters" class="close-btn">読込</button>
      </div>
      <div id="themeChips" class="chips"></div>
    </div>
    <div class="card">
      <h3>タグ（複数 / 投稿は最大3）</h3>
      <div class="row">
        <input id="tagInput" placeholder="例: ブリンク" style="flex:1">
        <button id="tagAdd">追加</button>
      </div>
      <div id="tagChips" class="chips"></div>
    </div>
    <div class="card">
      <h3>投票理由（Next下に並ぶ小ボタン）</h3>
      <div class="row">
        <input id="reasonInput" placeholder="例: 除去" style="flex:1">
        <button id="reasonAdd">追加</button>
      </div>
      <div id="reasonChips" class="chips"></div>
    </div>
    <div class="row">
      <button id="btnSaveMasters" class="ok">保存</button>
      <button class="close-btn" data-close>閉じる</button>
    </div>
    <div class="muted">※ <code>admin2?action=set_masters</code> に統一</div>
  </details>

  <!-- ====== 13) XP / レベル条件 と マナ付与ルール ====== -->
  <details class="section" open>
    <summary><h2>XP / レベル条件 と マナ付与ルール</h2></summary>
    <div class="grid" style="margin-top:10px">
      <div>
        <div class="muted" style="margin-bottom:4px">XP / レベル条件（JSON）</div>
        <textarea id="xpJson" placeholder='例: {"levels":[{"lv":1,"xp":0},{"lv":2,"xp":100}]}'></textarea>
      </div>
      <div>
        <div class="muted" style="margin-bottom:4px">マナ付与ルール（JSON）</div>
        <textarea id="manaJson" placeholder='例: {"perVote":1,"perReport":-2}'></textarea>
      </div>
      <div class="row">
        <button id="btnLoadRules">ルール読み込み</button>
        <button id="btnSaveRules" class="ok">ルール保存</button>
        <button class="close-btn" data-close>閉じる</button>
      </div>
      <div class="muted">※ <code>app_settings</code> の <code>xp_rules / mana_rules</code> を読み書き</div>
    </div>
  </details>

<script>
const ADMIN2_URL = "https://onzljxnqlrohkzsfxqbh.supabase.co/functions/v1/admin2";
const $id = (id)=>document.getElementById(id);
$id("token").value = localStorage.getItem("admin_token") || "";
$id("token").addEventListener("input",()=>localStorage.setItem("admin_token",$id("token").value));

// summaryの開閉は標準動作を許可
document.querySelectorAll('[data-close]').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    const details = e.target.closest('details');
    if(details) details.open = false;
  });
});

function el(tag, attrs={}, ...children){
  const e=document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className=v;
    else if(k==="href") e.setAttribute("href", v);
    else if(k==="target") e.setAttribute("target", v);
    else if(k==="rel") e.setAttribute("rel", v);
    else if(k==="value") e.value = v;
    else e.setAttribute(k, v);
  }
  for(const c of children){
    if(c==null) continue;
    if(typeof c==="string") e.appendChild(document.createTextNode(c));
    else e.appendChild(c);
  }
  return e;
}

function clearNode(id){ const el=document.getElementById(id); if(el) el.innerHTML=''; }
function fmtDate(s){ try{ return new Date(s).toLocaleString('ja-JP',{ timeZone:'Asia/Tokyo', hour12:false }); }catch{ return s; } }
function clearBox(node){ node.innerHTML=""; }
function JErr(box,e){ box.innerHTML = ""; box.append(el("div",{class:"muted"},`未対応またはエラー：${(e?.message||e)}`)); }
const banner = $id("banner");

// 汎用API
async function callAdmin2(query, opt={}){
  const token = $id("token").value.trim();
  if(!token){ throw new Error("Admin Token が未入力です"); }
  const url = (query.startsWith("http")?query:`${ADMIN2_URL}${query}`);
  const init = { method: opt.method||"GET", headers: { "x-admin-token": token, "content-type":"application/json" } };
  if(opt.body) init.body = JSON.stringify(opt.body);
  const res = await fetch(url, init);
  const txt = await res.text();
  let json; try{ json = JSON.parse(txt); }catch{ json = { ok:false, error:txt } }
  if(!res.ok || json?.ok===false) throw new Error(json?.error||res.statusText);
  return json;
}

// ---------- 2) 通報しきい値 ----------
async function loadSettingsOnlyThreshold(){
  try{
    const j = await callAdmin2(`?view=settings`);
    $id("th").value = j?.data?.report_delete_threshold?.value ?? j?.data?.report_delete_threshold ?? 5;
  }catch(e){ alert("設定取得エラー: "+e.message); }
}
async function saveSettingsOnlyThreshold(){
  try{
    const n = Number($id("th").value);
    await callAdmin2("",{ method:"POST", body:{ action:"set_settings", report_delete_threshold:n }});
    alert("保存しました");
  }catch(e){ alert("保存エラー: "+e.message); }
}
$id("btnLoadSet").onclick = loadSettingsOnlyThreshold;
$id("btnSaveSet").onclick = saveSettingsOnlyThreshold;

// ---------- 13) XP / マナ 取り出し・保存（堅牢化） ----------
function extractSettingValue(obj, key){
  const cands = [
    obj?.data?.[key],
    obj?.data?.[key]?.value,
    obj?.[key],
    obj?.[key]?.value,
    obj?.data?.settings?.[key],
    obj?.data?.settings?.[key]?.value
  ];
  for (const c of cands){
    if (c == null) continue;
    if (typeof c === "string"){
      try { return JSON.parse(c); } catch { return c; }
    }
    if (typeof c === "object") return c;
    if (typeof c === "number" || typeof c === "boolean") return c;
  }
  return null;
}
async function loadRules(){
  try{
    const j = await callAdmin2(`?view=settings`);
    const xp   = extractSettingValue(j, "xp_rules");
    const mana = extractSettingValue(j, "mana_rules");
    $id("xpJson").value   = xp   ? JSON.stringify(xp,   null, 2) : "";
    $id("manaJson").value = mana ? JSON.stringify(mana, null, 2) : "";
    if (!$id("xpJson").value && !$id("manaJson").value){
      banner.textContent = "XP/マナルールが未設定か、サーバ側の応答形式が想定外です（value包み/文字列JSON等）。";
      banner.style.display = "block";
    }else{
      banner.style.display = "none";
    }
  }catch(e){
    alert("ルール取得エラー: "+e.message);
  }
}
async function saveRules(){
  try{
    const body = { action:"set_settings" };
    const th = Number($id("th").value || 5);
    if (Number.isFinite(th)) body.report_delete_threshold = th;
    const xpTxt = $id("xpJson").value.trim();
    const mnTxt = $id("manaJson").value.trim();
    if (xpTxt)  body.xp_rules   = JSON.parse(xpTxt);
    if (mnTxt)  body.mana_rules = JSON.parse(mnTxt);
    await callAdmin2("", { method:"POST", body });
    alert("保存しました");
  }catch(e){
    alert("JSON or 保存エラー: "+e.message);
  }
}
$id("btnLoadRules").onclick = loadRules;
$id("btnSaveRules").onclick = saveRules;

// ---------- 6) サマリー ----------
$id("btnLoadSummary").onclick = async ()=>{
  const box=$id("sumBox"); box.innerHTML="読み込み中…";
  try{
    const days=Number($id("days_sum").value||7);
    const j = await callAdmin2(`?view=analytics_summary&days=${days}`);
    box.innerHTML="";
    const mk=(label,val)=>el("div",{class:"box"}, el("div",{class:"muted"},label), el("b",{}, String(val)));
    const d = j.data||{};
    box.append(
      mk("期間", d.label || `過去${days}日`),
      mk("平均RT(>=5s)", d.avg_rt ?? "-"),
      mk("中央値(>=5s)", d.p50 ?? "-"),
      mk("件数 n", d.n ?? "-"),
      mk("PV", d.pv ?? "-"),
      mk("UU(投票者)", d.uu_voters ?? "-")
    );
  }catch(e){ JErr(box,e); }
};

// ---------- 人気デッキ ----------
$id("btnLoadPop").onclick = async ()=>{
  const box=$id("popBox"); box.innerHTML="読み込み中…";
  try{
    const days = Number($id("days_pop").value||7);
    const limit= Number($id("limit_pop").value||20);
    const j = await callAdmin2(`?view=votes_deck&days=${days}&limit=${limit}`);
    const rows = j.data||[];
    box.innerHTML="";
    if(!rows.length){ box.append(el("div",{class:"muted"},"0件")); return; }
    for(const r of rows){
      const card = el("div",{class:"card"});
      const row = el("div",{class:"row"});
      row.append(
        el("a",{class:"link",href:r.source_url,target:"_blank",rel:"noopener noreferrer"}, r.deck_name||r.source_url||r.deck_id),
        el("span",{class:"pill mono"},`ID ${r.deck_id}`),
        el("span",{class:"muted"},`votes ${r.votes}`)
      );
      card.append(row);
      box.append(card);
    }
  }catch(e){ JErr(box,e); }
};

// ---------- 1) 通報一覧（関数化 & 自動実行用） ----------
async function loadReports(){
  const box = $id("reportList"); clearBox(box);
  try{
    const q = $id("q").value.trim();
    const min = Number($id("min").value||1);
    const limit = Number($id("limit").value||50);
    const from = $id("from").value || "";
    const to   = $id("to").value   || "";
    const qs = new URLSearchParams({ view:"reports", min, limit });
    if(q) qs.set("q", q);
    if(from) qs.set("from", from);
    if(to) qs.set("to", to);
    const j = await callAdmin2(`?${qs.toString()}`);
    const data = j.data||[];
    if(!data.length){ box.append(el("div",{class:"muted"},"0件")); return; }
    for(const r of data){
      const div = el("div",{class:"card"});
      const row1 = el("div",{class:"row"});
      row1.append(
        el("a",{href:r.deck_source_url,target:"_blank",rel:"noopener noreferrer",class:"link"}, r.deck_name || r.deck_source_url),
        el("span",{class:"pill mono"},`ID ${r.deck_id}`)
      );
      const row2 = el("div",{class:"row muted"}, `通報 ${r.report_count} / 最終 ${fmtDate(r.latest_reported_at)} / 登録者 ${r.author_ip||"-"} / ${r.author_session||"-"}`);

      const btns = el("div",{class:"btns"});
      const btnBan = el("button",{class:"warn"},"投稿者BAN");
      btnBan.onclick = async ()=>{
        if(!confirm("このデッキの投稿者をIP/Sessionでブロックしますか？")) return;
        try{ await callAdmin2("",{method:"POST", body:{action:"block_author_of_deck", deck_id:r.deck_id}}); alert("ブロックしました"); }
        catch(e){ alert("BAN失敗: "+e.message); }
      };
      const btnDel = el("button",{class:"danger"},"削除");
      btnDel.onclick = async ()=>{
        if(!confirm("このデッキを削除しますか？")) return;
        try{ await callAdmin2("",{method:"POST", body:{action:"delete_deck", deck_id:r.deck_id}}); div.remove(); }
        catch(e){ alert("削除失敗: "+e.message); }
      };
      const btnClr = el("button",{},"通報クリア");
      btnClr.onclick = async ()=>{
        try{ await callAdmin2("",{method:"POST", body:{action:"clear_reports", deck_id:r.deck_id}}); alert("クリアしました"); }
        catch(e){ alert("失敗: "+e.message); }
      };
      const btnPd = el("button",{},"保留にする");
      btnPd.onclick= async ()=>{
        try{ await callAdmin2("",{method:"POST", body:{action:"schedule_delete_deck", deck_id:r.deck_id, reason:"reports"}}); alert("保留にしました"); }
        catch(e){ alert("失敗: "+e.message); }
      };
      btns.append(btnBan, btnDel, btnClr, btnPd);
      div.append(row1,row2,btns);
      box.append(div);
    }
  }catch(e){ JErr(box,e); }
}
$id("btnLoadReports").onclick = loadReports;

// ---------- 7) RT ----------
$id("btnLoadRT").onclick = async ()=>{
  const box=$id("rtBox"); clearBox(box);
  try{
    const days = Number($id("days_rt").value||7);
    const j = await callAdmin2(`?view=rt_global&days=${days}`);
    const res=j.data||[];
    if(!res.length){ box.append(el("div",{class:"muted"},"0件")); return; }
    for(const r of res){
      const avgNum = Number(r.avg_rt ?? r.avg ?? r.avg_sec ?? 0);
      const avgTxt = isFinite(avgNum) && avgNum>0 ? avgNum.toFixed(1) : String(r.avg_rt ?? r.avg ?? "0.0");
      const elc=el("div",{class:"card"});
      elc.append(el("div",{class:"row"}, el("b",{}, r.label||(`過去${days}日`)), el("span",{class:"muted"},`avg ${avgTxt}s / n=${r.n ?? "-"}`)));
      if(!(isFinite(avgNum) && avgNum>0) && (r.n>0)){
        elc.append(el("div",{class:"muted"},"※ 平均が 0 秒です。admin2 側の RT 集計をご確認ください。"));
      }
      box.append(elc);
    }
  }catch(e){ JErr(box,e); }
};

// ---------- 7) アクセス数（堅牢パース＋ゼロ埋め） ----------
function parseBucketToUTC(b, grain){
  const s = String(b);
  // "YYYY-MM-DD HH:00" / "YYYY-MM-DDTHH:00Z" / ISO などを吸収
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2})(?::?(\d{2}))?)?/);
  if (m){
    const Y=+m[1], M=+m[2]-1, D=+m[3], h=+(m[4]||0), mi=+(m[5]||0);
    return new Date(Date.UTC(Y,M,D,h,mi,0,0));
  }
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d; // 既にUTC扱い（表示時にJST変換）
}
function formatJST(dt){
  return dt.toLocaleString('ja-JP', { timeZone:'Asia/Tokyo', hour12:false });
}
$id("btnLoadImp").onclick = async ()=>{
  const box=$id("impBox"); clearBox(box);
  try{
    const days = Number($id("days_imp").value||7);
    const grain = $id("grain").value; // "hour" | "day"
    const j = await callAdmin2(`?view=impressions&days=${days}&grain=${grain}`);
    const rows = (j.data||[]).map(r => ({ bucket:r.bucket, count:Number(r.count||0) }));

    // 1) Mapに詰め直し（UTCのミリ秒キー）
    const byTs = new Map();
    for(const r of rows){
      const d = parseBucketToUTC(r.bucket, grain);
      if(!d) continue;
      byTs.set(d.getTime(), (byTs.get(d.getTime())||0)+r.count);
    }

    // 2) 連続バケットをゼロ埋め
    const now = new Date();
    let cur;
    if (grain === 'hour'){
      cur = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours(), 0,0,0));
      cur = new Date(cur.getTime() - days*24*3600*1000); // days 前の時間端
    }else{ // day
      cur = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0,0,0,0));
      cur = new Date(cur.getTime() - days*24*3600*1000);
    }
    const end = new Date();
    const stepMs = (grain==='hour') ? 3600*1000 : 24*3600*1000;

    const filled = [];
    for(let t = cur.getTime(); t <= end.getTime(); t += stepMs){
      const cnt = byTs.get(t) || 0;
      filled.push({ ts:t, count:cnt });
    }

    if(!filled.length){ box.append(el("div",{class:"muted"},"0件")); return; }

    for(const r of filled){
      const label = formatJST(new Date(r.ts));
      const elc = el("div",{class:"card"});
      elc.append(el("div",{class:"row"}, el("b",{},label), el("span",{class:"muted"},`${r.count} 件`)));
      box.append(elc);
    }
  }catch(e){ JErr(box,e); }
};

// ---------- 7) デッキ別投票 ----------
$id("btnLoadVBD").onclick = async ()=>{
  const box=$id("vbdBox"); clearBox(box);
  try{
    const days = Number($id("days_vbd").value||7);
    const limit= Number($id("vbd_limit").value||100);
    const j = await callAdmin2(`?view=votes_deck&days=${days}&limit=${limit}`);
    const res = j.data||[];
    if(!res.length){ box.append(el("div",{class:"muted"},"0件")); return; }
    for(const r of res){
      const elc=el("div",{class:"card"});
      elc.append(el("div",{class:"row"},
        el("a",{class:"link",target:"_blank",rel:"noopener noreferrer",href:r.source_url}, r.deck_name || r.source_url || r.deck_id),
        el("span",{class:"pill mono"},`ID ${r.deck_id}`),
        el("span",{class:"muted"},`votes ${r.votes}`)
      ));
      box.append(elc);
    }
  }catch(e){ JErr(box,e); }
};

// ---------- 11) ブロック一覧 ----------
async function postBlockIp(ip){ if(!ip) return; try{ await callAdmin2("",{method:"POST",body:{action:"block_ip",ip}}); loadBlocklist(); }catch(e){ alert(e.message); } }
async function postUnblockIp(ip, row){ try{ await callAdmin2("",{method:"POST",body:{action:"unblock_ip",ip}}); row.remove(); }catch(e){ alert(e.message); } }
async function postBlockSession(session_id){ if(!session_id) return; try{ await callAdmin2("",{method:"POST",body:{action:"block_session",session_id}}); loadBlocklist(); }catch(e){ alert(e.message); } }
async function postUnblockSession(session_id, row){ try{ await callAdmin2("",{method:"POST",body:{action:"unblock_session",session_id}}); row.remove(); }catch(e){ alert(e.message); } }

async function loadBlocklist(){
  const box=$id("blocklist"); clearBox(box);
  try{
    const j = await callAdmin2(`?view=blocklist`);
    const ips = j.ips||[], sids=j.sessions||[];
    const ipCard=el("div",{class:"card"}); ipCard.append(el("h3",{},"IP"));
    const ipList=el("div",{class:"grid"});
    for(const r of ips){
      const row=el("div",{class:"row"});
      row.append(el("span",{class:"mono"}, r.ip));
      const un=el("button",{},"解除"); un.onclick=()=> postUnblockIp(r.ip,row);
      row.append(un); ipList.append(row);
    }
    const addRow=el("div",{class:"row"});
    const ipIn=el("input",{placeholder:"IP"});
    const add=el("button",{},"IPブロック"); add.onclick=()=> postBlockIp(ipIn.value, ipList);
    addRow.append(ipIn,add); ipCard.append(ipList,addRow);

    const sidCard=el("div",{class:"card"}); sidCard.append(el("h3",{},"Session"));
    const sidList=el("div",{class:"grid"});
    for(const r of sids){
      const row=el("div",{class:"row"});
      row.append(el("span",{class:"mono"}, r.session_id));
      const un=el("button",{},"解除"); un.onclick=()=> postUnblockSession(r.session_id,row);
      row.append(un); sidList.append(row);
    }
    const addRow2=el("div",{class:"row"});
    const sidIn=el("input",{placeholder:"Session"});
    const add2=el("button",{},"Sessionブロック"); add2.onclick=()=> postBlockSession(sidIn.value, sidList);
    addRow2.append(sidIn,add2); sidCard.append(sidList,addRow2);

    box.append(ipCard,sidCard);
  }catch(e){ JErr(box,e); }
}
$id("btnLoadBL").onclick = loadBlocklist;

// ---------- 10) 通報者 ----------
$id("btnLoadRep").onclick = async ()=>{
  const box=$id("reporters"); clearBox(box);
  try{
    const days=Number($id("days_rep").value||7), limit=Number($id("limit_rep").value||100);
    const j=await callAdmin2(`?view=reporters&days=${days}&limit=${limit}`);
    const data=j.data||[];
    if(!data.length){ box.append(el("div",{class:"muted"},"0件")); return; }
    for(const r of data){
      const elc=el("div",{class:"card"});
      elc.append(el("div",{class:"row"},
        el("span",{class:"mono"}, `${r.ip||"(no ip)"} / ${r.session_id||"(no session)"}`),
        el("span",{class:"muted"}, `件数 ${r.count} / 最終 ${fmtDate(r.last)}`)
      ));
      const btns=el("div",{class:"btns"});
      if(r.ip){ const b=el("button",{}, r.blocked_ip?"IP解除":"IPブロック"); b.onclick=()=> (r.blocked_ip?postUnblockIp(r.ip,elc):postBlockIp(r.ip)); btns.append(b); }
      if(r.session_id){ const b2=el("button",{}, r.blocked_session?"Session解除":"Sessionブロック"); b2.onclick=()=> (r.blocked_session?postUnblockSession(r.session_id,elc):postBlockSession(r.session_id)); btns.append(b2); }
      elc.append(btns); box.append(elc);
    }
  }catch(e){ JErr(box,e); }
};

// ---------- 9) 登録者 ----------
$id("btnLoadReg").onclick = async ()=>{
  const box=$id("registrants"); clearBox(box);
  try{
    const days=Number($id("days_reg").value||7), limit=Number($id("limit_reg").value||100);
    const j=await callAdmin2(`?view=registrants&days=${days}&limit=${limit}`);
    const data=j.data||[];
    if(!data.length){ box.append(el("div",{class:"muted"},"0件")); return; }
    for(const r of data){
      const elc=el("div",{class:"card"});
      elc.append(el("div",{class:"row"},
        el("span",{class:"mono"}, `${r.ip||"(no ip)"} / ${r.session_id||"(no session)"}`),
        el("span",{class:"muted"}, `件数 ${r.count} / 最終 ${fmtDate(r.last)}`)
      ));
      const btns=el("div",{class:"btns"});
      if(r.ip){ const b=el("button",{}, r.blocked_ip?"IP解除":"IPブロック"); b.onclick=()=> (r.blocked_ip?postUnblockIp(r.ip,elc):postBlockIp(r.ip)); btns.append(b); }
      if(r.session_id){ const b2=el("button",{}, r.blocked_session?"Session解除":"Sessionブロック"); b2.onclick=()=> (r.blocked_session?postUnblockSession(r.session_id,elc):postBlockSession(r.session_id)); btns.append(b2); }
      elc.append(btns); box.append(elc);
    }
  }catch(e){ JErr(box,e); }
};

// ---------- 3) 復旧一覧 ----------
$id("btnLoadDel").onclick = async ()=>{
  const box=$id("deletedList"); clearBox(box);
  try{
    const days=Number($id("days_del").value||30), limit=Number($id("limit_del").value||100);
    const j=await callAdmin2(`?view=deleted_list&days=${days}&limit=${limit}`);
    const data=j.data||[];
    if(!data.length){ box.append(el("div",{class:"muted"},"0件")); return; }
    for(const r of data){
      const elc=el("div",{class:"card"});
      const row1=el("div",{class:"row"});
      row1.append(
        el("a",{href:r.source_url,target:"_blank",rel:"noopener noreferrer",class:"link"}, r.deck_name||r.source_url||r.deck_id||"(deleted)"),
        el("span",{class:"pill mono"},`deck ${r.deck_id||"-"}`)
      );
      const row2=el("div",{class:"row muted"}, `削除: ${fmtDate(r.deleted_at)} / 理由: ${r.reason||"-"} / by ${r.deleted_by||"-"}`);
      const btn=el("button",{class:"ok"},"復旧");
      btn.onclick=async()=>{ try{ await callAdmin2("",{method:"POST",body:{action:"restore_deck", log_id:r.id}}); elc.remove(); }catch(e){ alert("復旧失敗: "+e.message); } };
      elc.append(row1,row2,btn); box.append(elc);
    }
  }catch(e){ JErr(box,e); }
};

// ---------- 5) 保留削除 ----------
$id("btnLoadPending").onclick = async ()=>{
  const box=$id("pendingList"); clearBox(box);
  try{
    const j=await callAdmin2(`?view=pending_deletes`);
    const list=j.data||[];
    if(!list.length){ box.append(el("div",{class:"muted"},"0件")); return; }
    for(const r of list){
      const elc=el("div",{class:"card"});
      elc.append(
        el("div",{class:"row"},
          el("a",{class:"link",target:"_blank",rel:"noopener noreferrer",href:r.source_url}, r.deck_name||r.source_url||r.id),
          el("span",{class:"pill mono"},`ID ${r.id}`)
        ),
        el("div",{class:"muted"}, `保留時刻: ${fmtDate(r.pending_delete_at)} / 理由: ${r.pending_delete_reason||"-"}`)
      );
      const btns=el("div",{class:"btns"});
      const ok=el("button",{class:"danger"},"削除を確定"); ok.onclick=async()=>{
        try{ await callAdmin2("",{method:"POST", body:{action:"confirm_delete_deck", deck_id:r.id}}); elc.remove(); }catch(e){ alert(e.message); }
      };
      const cancel=el("button",{},"保留を取消"); cancel.onclick=async()=>{
        try{ await callAdmin2("",{method:"POST", body:{action:"cancel_pending_delete", deck_id:r.id}}); elc.remove(); }catch(e){ alert(e.message); }
      };
      btns.append(ok,cancel); elc.append(btns); box.append(elc);
    }
  }catch(e){ JErr(box,e); }
};

// ---------- 8) 理由トップ ----------
$id("btnLoadReasonTop").onclick = async ()=>{
  const box=$id("reasonTop"); clearBox(box);
  try{
    const days=Number($id("days_reason").value||7);
    const deck=$id("deck_reason").value.trim();
    const qs = new URLSearchParams({ view:"reasons_top", days });
    if(deck) qs.set("deck_id", deck);
    const j=await callAdmin2(`?${qs.toString()}`);
    const list=j.data||[];
    if(!list.length){ box.append(el("div",{class:"muted"},"0件")); return; }
    for(const r of list){
      const elc=el("div",{class:"card"});
      elc.append(el("div",{class:"row"},
        el("b",{}, r.label),
        el("span",{class:"muted"}, `(${r.key})`),
        el("span",{class:"pill mono"}, String(r.count))
      ));
      box.append(elc);
    }
  }catch(e){ JErr(box,e); }
};

// ---------- 12) マスター編集 ----------
let THEMES=[], TAGS=[], REASONS=[];
function renderChips(){
  const tc=$id("themeChips"); tc.innerHTML="";
  THEMES.forEach(v=>{
    const s=el("span",{class:"chip"}, v+" ");
    const x=el("span",{class:"x"},"×");
    x.onclick=()=>{ THEMES=THEMES.filter(a=>a!==v); renderChips(); };
    s.appendChild(x); tc.appendChild(s);
  });
  const gc=$id("tagChips"); gc.innerHTML="";
  TAGS.forEach(v=>{
    const s=el("span",{class:"chip"}, v+" ");
    const x=el("span",{class:"x"},"×");
    x.onclick=()=>{ TAGS=TAGS.filter(a=>a!==v); renderChips(); };
    s.appendChild(x); gc.appendChild(s);
  });
  const rc=$id("reasonChips"); rc.innerHTML="";
  REASONS.forEach(v=>{
    const s=el("span",{class:"chip"}, v+" ");
    const x=el("span",{class:"x"},"×");
    x.onclick=()=>{ REASONS=REASONS.filter(a=>a!==v); renderChips(); };
    s.appendChild(x); rc.appendChild(s);
  });
}
$id("themeAdd").onclick = ()=>{ const v=$id("themeInput").value.trim(); if(v && !THEMES.includes(v)) THEMES.push(v); $id("themeInput").value=""; renderChips(); };
$id("tagAdd").onclick   = ()=>{ const v=$id("tagInput").value.trim();   if(v && !TAGS.includes(v))   TAGS.push(v);   $id("tagInput").value="";   renderChips(); };
$id("reasonAdd").onclick= ()=>{ const v=$id("reasonInput").value.trim();if(v && !REASONS.includes(v))REASONS.push(v);$id("reasonInput").value="";renderChips(); };

async function loadMasters(){
  try{
    const j=await callAdmin2(`?view=masters`);
    THEMES = Array.isArray(j.data?.themes)? j.data.themes: [];
    TAGS   = Array.isArray(j.data?.tags)?   j.data.tags  : [];
    REASONS= Array.isArray(j.data?.reasons)?j.data.reasons: [];
    renderChips();
  }catch(e){ alert("マスター読込エラー: "+e.message); }
}
async function saveMasters(){
  try{
    await callAdmin2("",{method:"POST",body:{action:"set_masters",themes:THEMES,tags:TAGS,reasons:REASONS}});
    alert("保存しました");
  }catch(e){ alert("保存エラー: "+e.message); }
}
$id("btnLoadMasters").onclick = loadMasters;
$id("btnSaveMasters").onclick = saveMasters;

// ---------- 初期ロード ----------
(function boot(){
  // 直近操作に便利なのでしきい値は自動読込
  loadSettingsOnlyThreshold().catch(()=>{});
  // 通報一覧は「保存済みトークンがある場合のみ」自動ロード（未設定でアラート連打を防止）
  const saved = localStorage.getItem("admin_token");
  if (saved && saved.trim()) {
    loadReports().catch(()=>{});
  }
})();
</script>
</body>
</html>
