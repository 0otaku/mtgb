<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- 検索避け -->
  <meta name="robots" content="noindex,nofollow">
  <title>管理 | みんなでブラケット診断</title>
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;padding:16px;background:#fff;color:#0f172a}
    h2{margin:18px 0 8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button,select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
    button{cursor:pointer;background:#fff}
    .grid{display:grid;gap:10px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .muted{color:#64748b;font-size:12px}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    .danger{background:#dc2626;color:#fff;border-color:#dc2626}
    .warn{background:#f59e0b;color:#111827;border-color:#f59e0b}
    .ok{background:#16a34a;color:#fff;border-color:#16a34a}
    .link{color:#2563eb;text-decoration:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .section{margin-top:16px}
  </style>
</head>
<body>
  <div class="row">
    <b>管理</b>
    <label>Admin Token: <input id="token" placeholder="保存されます" style="min-width:260px"></label>
  </div>

  <div class="section">
    <h2>通報一覧</h2>
    <div class="row">
      <label>検索 <input id="q" placeholder="URL/名前"></label>
      <label>最小通報数 <input id="min" type="number" value="1" style="width:90px"></label>
      <label>件数 <input id="limit" type="number" value="50" style="width:90px"></label>
      <label>From <input id="from" type="date"></label>
      <label>To <input id="to" type="date"></label>
      <button id="load">読み込み</button>
    </div>
    <div id="list" class="grid"></div>
  </div>

  <div class="section">
    <h2>通報者（上位）</h2>
    <div class="row">
      <label>過去 <input id="days" type="number" value="7" style="width:90px"></label> 日間
      <label>件数 <input id="limit_rep" type="number" value="100" style="width:90px"></label>
      <button id="loadRep">読み込み</button>
    </div>
    <div id="reporters" class="grid"></div>
  </div>

  <div class="section">
    <h2>登録者（上位）</h2>
    <div class="row">
      <label>過去 <input id="days_reg" type="number" value="7" style="width:90px"></label> 日間
      <label>件数 <input id="limit_reg" type="number" value="100" style="width:90px"></label>
      <button id="loadReg">読み込み</button>
    </div>
    <div id="registrants" class="grid"></div>
  </div>

  <div class="section">
    <h2>ブロック一覧</h2>
    <div class="row"><button id="loadBL">更新</button></div>
    <div class="grid" id="blocklist"></div>
  </div>

<script>
const FN = "https://onzljxnqlrohkzsfxqbh.supabase.co/functions/v1/admin-reports";
const $ = (id)=>document.getElementById(id);
$("token").value = localStorage.getItem("admin_token") || "";
$("token").addEventListener('change',()=>localStorage.setItem("admin_token",$("token").value));

$("load").onclick = loadReports;
$("loadRep").onclick = loadReporters;
$("loadReg").onclick = loadRegistrants;
$("loadBL").onclick = loadBlocklist;

async function api(pathOrQuery, opts={}){
  const token=$("token").value.trim(); if(!token){ alert("Admin Tokenを入力してください"); throw new Error('no token'); }
  const url = pathOrQuery.startsWith("http") ? pathOrQuery : `${FN}${pathOrQuery}`;
  const r = await fetch(url, { ...opts, headers: { ...(opts.headers||{}), "x-admin-token": token } });
  if(!r.ok){ throw new Error(await r.text()); }
  return r.json();
}

/* 通報一覧 */
async function loadReports(){
  const q = $("q").value.trim();
  const min = $("min").value || "1";
  const limit = $("limit").value || "50";
  const from = $("from").value;
  const to   = $("to").value;
  const query = `?view=reports&min=${encodeURIComponent(min)}&limit=${encodeURIComponent(limit)}${from?`&from=${from}`:''}${to?`&to=${to}`:''}${q?`&q=${encodeURIComponent(q)}`:''}`;
  const j = await api(query, { method: "GET" });
  const list = $("list");
  const fmt = (d)=>new Date(d).toLocaleString();
  list.innerHTML = (j.data||[]).map(x=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div>
          <div><b>${x.deck_name || '(名称なし)'}</b></div>
          <div class="muted">通報: ${x.report_count}件 / 最終: ${fmt(x.latest_reported_at)} / 登録日: ${x.registered_at||'—'}</div>
          <div><a class="link mono" href="${x.deck_source_url}" target="_blank" rel="noopener">${x.deck_source_url}</a></div>
        </div>
        <div class="btns">
          <button class="warn" onclick="clearReports('${x.deck_id}')">通報クリア</button>
          <button class="danger" onclick="delDeck('${x.deck_id}')" title="ラベルも含め削除されます">削除</button>
        </div>
      </div>
    </div>
  `).join('') || '<div class="muted">該当なし</div>';
}
async function delDeck(id){
  if(!confirm("このデッキを削除しますか？（投票・通報も消えます）")) return;
  await api("", { method:"POST", body: JSON.stringify({ action:"delete_deck", deck_id:id }), headers:{ "Content-Type":"application/json" }});
  loadReports();
}
async function clearReports(id){
  if(!confirm("このデッキの通報を全て削除しますか？")) return;
  await api("", { method:"POST", body: JSON.stringify({ action:"clear_reports", deck_id:id }), headers:{ "Content-Type":"application/json" }});
  loadReports();
}

/* 通報者（上位） */
async function loadReporters(){
  const limit = $("limit_rep").value || "100";
  const days = $("days").value || "7";
  const j = await api(`?view=reporters&limit=${encodeURIComponent(limit)}&days=${encodeURIComponent(days)}`, { method:"GET" });
  const L = $("reporters");
  const fmt = (d)=>new Date(d).toLocaleString();
  L.innerHTML = (j.data||[]).map(r=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div>
          <div>IP: <span class="mono">${r.ip || '-'}</span> / Session: <span class="mono">${r.session_id || '-'}</span></div>
          <div class="muted">通報: ${r.count}件 / 最終: ${fmt(r.last)}</div>
        </div>
        <div class="btns">
          ${r.ip ? (r.blocked_ip
            ? `<button class="ok" onclick="unblockIp('${r.ip}')">IP解除</button>`
            : `<button class="danger" onclick="blockIp('${r.ip}')">IPブロック</button>`) : ''}
          ${r.session_id ? (r.blocked_session
            ? `<button class="ok" onclick="unblockSession('${r.session_id}')">セッション解除</button>`
            : `<button class="danger" onclick="blockSession('${r.session_id}')">セッションブロック</button>`) : ''}
        </div>
      </div>
    </div>
  `).join('') || '<div class="muted">該当なし</div>';
}

/* ★登録者（上位） */
async function loadRegistrants(){
  const limit = $("limit_reg").value || "100";
  const days = $("days_reg").value || "7";
  const j = await api(`?view=registrants&limit=${encodeURIComponent(limit)}&days=${encodeURIComponent(days)}`, { method:"GET" });
  const L = $("registrants");
  const fmt = (d)=>new Date(d).toLocaleString();
  L.innerHTML = (j.data||[]).map(r=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div>
          <div>IP: <span class="mono">${r.ip || '-'}</span> / Session: <span class="mono">${r.session_id || '-'}</span></div>
          <div class="muted">登録: ${r.count}件 / 最終: ${fmt(r.last)}</div>
        </div>
        <div class="btns">
          ${r.ip ? (r.blocked_ip
            ? `<button class="ok" onclick="unblockIp('${r.ip}')">IP解除</button>`
            : `<button class="danger" onclick="blockIp('${r.ip}')">IPブロック</button>`) : ''}
          ${r.session_id ? (r.blocked_session
            ? `<button class="ok" onclick="unblockSession('${r.session_id}')">セッション解除</button>`
            : `<button class="danger" onclick="blockSession('${r.session_id}')">セッションブロック</button>`) : ''}
        </div>
      </div>
    </div>
  `).join('') || '<div class="muted">該当なし</div>';
}

/* ブロック操作＆一覧 */
async function apiPost(payload){ return api("", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) }); }
async function blockIp(ip){ await apiPost({ action:"block_ip", ip }); loadReporters(); loadRegistrants(); loadBlocklist(); }
async function unblockIp(ip){ await apiPost({ action:"unblock_ip", ip }); loadReporters(); loadRegistrants(); loadBlocklist(); }
async function blockSession(session_id){ await apiPost({ action:"block_session", session_id }); loadReporters(); loadRegistrants(); loadBlocklist(); }
async function unblockSession(session_id){ await apiPost({ action:"unblock_session", session_id }); loadReporters(); loadRegistrants(); loadBlocklist(); }

async function loadBlocklist(){
  const j = await api(`?view=blocklist`, { method:"GET" });
  const B = $("blocklist");
  B.innerHTML = `
    <div class="card">
      <div><b>IP</b></div>
      ${(j.ips||[]).map(x=>`
        <div class="row" style="justify-content:space-between">
          <span class="mono">${x.ip}</span>
          <div class="btns"><button class="ok" onclick="unblockIp('${x.ip}')">解除</button></div>
        </div>
      `).join('') || '<div class="muted">なし</div>'}
    </div>
    <div class="card">
      <div><b>セッション</b></div>
      ${(j.sessions||[]).map(x=>`
        <div class="row" style="justify-content:space-between">
          <span class="mono">${x.session_id}</span>
          <div class="btns"><button class="ok" onclick="unblockSession('${x.session_id}')">解除</button></div>
        </div>
      `).join('') || '<div class="muted">なし</div>'}
    </div>
  `;
}
</script>
</body>
</html>
