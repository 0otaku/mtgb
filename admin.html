<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>管理 | みんなでブラケット診断</title>
<meta name="robots" content="noindex, nofollow">
<style>
  body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;padding:16px;background:#fff;color:#0f172a}
  h1{margin:0 0 12px;font-size:18px}
  h2{margin:18px 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
  button{cursor:pointer;background:#fff}
  .grid{display:grid;gap:10px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .muted{color:#64748b;font-size:12px}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  .danger{background:#dc2626;color:#fff;border-color:#dc2626}
  .warn{background:#f59e0b;color:#111827;border-color:#f59e0b}
  .ok{background:#16a34a;color:#fff;border-color:#16a34a}
  .link{color:#2563eb;text-decoration:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
  .section{margin-top:16px}
  details>summary{cursor:pointer;user-select:none}
  .close-btn{margin-left:auto}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb}
</style>
<body>
  <div class="row">
    <h1>管理</h1>
    <label>Admin Token: <input id="token" placeholder="保存されます" style="min-width:320px"></label>
  </div>

  <!-- ====== 設定 ====== -->
  <details class="section" open>
    <summary><h2>設定</h2></summary>
    <div class="row">
      <label>通報しきい値 <input id="th" type="number" value="5" style="width:90px"></label>
      <button id="btnLoadSet">読み込み</button>
      <button id="btnSaveSet" class="ok">保存</button>
      <button class="close-btn" onclick="this.closest('details').open=false">閉じる</button>
    </div>
    <div class="muted">※ この件数以上の通報で該当デッキを自動削除します（admin2+SQLが必要）</div>
  </details>

  <!-- ====== 通報一覧 ====== -->
  <details class="section" open>
    <summary><h2>通報一覧</h2></summary>
    <div class="row">
      <label>検索 <input id="q" placeholder="URL/名前/ID"></label>
      <label>最小通報数 <input id="min" type="number" value="1" style="width:90px"></label>
      <label>件数 <input id="limit" type="number" value="50" style="width:90px"></label>
      <label>From <input id="from" type="date"></label>
      <label>To <input id="to" type="date"></label>
      <button id="btnLoadReports">読み込み</button>
      <button class="close-btn" onclick="this.closest('details').open=false">閉じる</button>
    </div>
    <div id="reportList" class="grid"></div>
  </details>

  <!-- ====== アナリティクス ====== -->
  <details class="section" open>
    <summary><h2>アナリティクス</h2></summary>

    <div class="card">
      <div class="row">
        <label>過去 <input id="days_rt" type="number" value="7" style="width:90px"></label> 日
        <button id="btnLoadRT">反応速度 読み込み</button>
        <button class="close-btn" onclick="this.closest('.card').style.display='none'">閉じる</button>
      </div>
      <div id="rtBox" class="grid"></div>
    </div>

    <div class="card">
      <div class="row">
        <label>過去 <input id="days_imp" type="number" value="7" style="width:90px"></label> 日
        <label><select id="grain">
          <option value="hour">時間</option><option value="day">日</option>
        </select></label>
        <button id="btnLoadImp">アクセス数 読み込み</button>
        <button class="close-btn" onclick="this.closest('.card').style.display='none'">閉じる</button>
      </div>
      <div id="impBox" class="grid"></div>
    </div>

    <div class="card">
      <div class="row">
        <label>過去 <input id="days_vbd" type="number" value="7" style="width:90px"></label> 日
        <label>件数 <input id="vbd_limit" type="number" value="100" style="width:90px"></label>
        <button id="btnLoadVBD">デッキ別投票数 読み込み</button>
        <button class="close-btn" onclick="this.closest('.card').style.display='none'">閉じる</button>
      </div>
      <div id="vbdBox" class="grid"></div>
    </div>
  </details>

  <!-- ====== ブロック一覧 ====== -->
  <details class="section" open>
    <summary><h2>ブロック一覧</h2></summary>
    <div class="row"><button id="btnLoadBL">読み込み</button><button class="close-btn" onclick="this.closest('details').open=false">閉じる</button></div>
    <div class="grid" id="blocklist"></div>
  </details>

  <!-- ====== 通報者 / 登録者 ====== -->
  <details class="section" open>
    <summary><h2>通報者（上位）</h2></summary>
    <div class="row">
      <label>過去 <input id="days_rep" type="number" value="7" style="width:90px"></label> 日間
      <label>件数 <input id="limit_rep" type="number" value="100" style="width:90px"></label>
      <button id="btnLoadRep">読み込み</button>
      <button class="close-btn" onclick="this.closest('details').open=false">閉じる</button>
    </div>
    <div id="reporters" class="grid"></div>
  </details>

  <details class="section" open>
    <summary><h2>登録者（上位）</h2></summary>
    <div class="row">
      <label>過去 <input id="days_reg" type="number" value="7" style="width:90px"></label> 日間
      <label>件数 <input id="limit_reg" type="number" value="100" style="width:90px"></label>
      <button id="btnLoadReg">読み込み</button>
      <button class="close-btn" onclick="this.closest('details').open=false">閉じる</button>
    </div>
    <div id="registrants" class="grid"></div>
  </details>

  <!-- ====== 復旧一覧 ====== -->
  <details class="section" open>
    <summary><h2>復旧一覧（自動/手動削除ログ）</h2></summary>
    <div class="row">
      <label>過去 <input id="days_del" type="number" value="30" style="width:90px"></label> 日間
      <label>件数 <input id="limit_del" type="number" value="100" style="width:90px"></label>
      <button id="btnLoadDel">読み込み</button>
      <button class="close-btn" onclick="this.closest('details').open=false">閉じる</button>
    </div>
    <div id="deletedList" class="grid"></div>
  </details>

<script>
/* ====== 接続設定 ====== */
const ADMIN2_URL = "https://onzljxnqlrohkzsfxqbh.supabase.co/functions/v1/admin2"; // ←自環境の admin2 URL に
const $id = (id)=>document.getElementById(id);
$id("token").value = localStorage.getItem("admin_token") || "";
$id("token").addEventListener("input",()=>localStorage.setItem("admin_token",$id("token").value));

/* ====== 汎用API ====== */
async function callAdmin2(query, opt={}){
  const token = $id("token").value.trim();
  if(!token){ alert("Admin Token を入力してください"); throw new Error("no token"); }
  const url = (query.startsWith("http")?query:`${ADMIN2_URL}${query}`);
  const init = {
    method: opt.method||"GET",
    headers: { "x-admin-token": token, "content-type":"application/json" }
  };
  if(opt.body) init.body = JSON.stringify(opt.body);
  const res = await fetch(url, init);
  const txt = await res.text();
  let json;
  try{ json = JSON.parse(txt); }catch{ json = { ok:false, error:txt } }
  if(!res.ok || json?.ok===false) throw new Error(json?.error||res.statusText);
  return json;
}
function fmtDate(s){ try{ return new Date(s).toLocaleString(); }catch{ return s; } }
function clearBox(node){ node.innerHTML=""; }

/* ====== 設定 ====== */
async function loadSettings(){
  try{
    const j = await callAdmin2(`?view=settings`);
    $id("th").value = j.data?.report_delete_threshold?.value ?? 5;
  }catch(e){ alert("設定取得エラー: "+e.message); }
}
async function saveSettings(){
  try{
    const n = Number($id("th").value);
    await callAdmin2("",{ method:"POST", body:{ action:"set_settings", report_delete_threshold:n }});
    alert("保存しました");
  }catch(e){ alert("保存エラー: "+e.message); }
}
$id("btnLoadSet").onclick = loadSettings;
$id("btnSaveSet").onclick = saveSettings;

/* ====== 通報一覧 ====== */
async function loadReports(){
  const box = $id("reportList");
  clearBox(box);
  try{
    const q = $id("q").value.trim();
    const min = Number($id("min").value||1);
    const limit = Number($id("limit").value||50);
    const from = $id("from").value || "";
    const to   = $id("to").value   || "";
    const qs = new URLSearchParams({ view:"reports", min, limit });
    if(q) qs.set("q", q);
    if(from) qs.set("from", from);
    if(to) qs.set("to", to);
    const j = await callAdmin2(`?${qs.toString()}`);
    const data = j.data||[];
    if(!data.length){ box.innerHTML = `<div class="muted">0件</div>`; return; }
    for(const r of data){
      const div = document.createElement("div"); div.className="card";
      const a = document.createElement("a"); a.href=r.deck_source_url; a.target="_blank"; a.className="link"; a.textContent = r.deck_name || r.deck_source_url;
      const idpill = `<span class="pill mono">ID ${r.deck_id}</span>`;
      const row1 = document.createElement("div"); row1.className="row";
      row1.append(a); row1.insertAdjacentHTML("beforeend", idpill);
      const row2 = document.createElement("div"); row2.className="row muted";
      row2.textContent = `通報 ${r.report_count} / 最終 ${fmtDate(r.latest_reported_at)}`;
      const btns = document.createElement("div"); btns.className="btns";
      const btnDel = document.createElement("button"); btnDel.className="danger"; btnDel.textContent="削除";
      btnDel.onclick = async ()=>{
        if(!confirm("このデッキを削除しますか？")) return;
        try{ await callAdmin2("",{method:"POST", body:{action:"delete_deck", deck_id:r.deck_id}}); div.remove(); }
        catch(e){ alert("削除失敗: "+e.message); }
      };
      const btnClr = document.createElement("button"); btnClr.className="warn"; btnClr.textContent="通報クリア";
      btnClr.onclick = async ()=>{
        try{ await callAdmin2("",{method:"POST", body:{action:"clear_reports", deck_id:r.deck_id}}); alert("クリアしました"); }
        catch(e){ alert("失敗: "+e.message); }
      };
      btns.append(btnDel, btnClr);
      div.append(row1,row2,btns);
      box.append(div);
    }
  }catch(e){ box.innerHTML = `<div class="muted">未対応またはエラー：${e.message}</div>`; }
}
$id("btnLoadReports").onclick = loadReports;

/* ====== アナリティクス ====== */
async function loadRT(){
  const box=$id("rtBox"); clearBox(box);
  try{
    const days = Number($id("days_rt").value||7);
    const j = await callAdmin2(`?view=rt_global&days=${days}`);
    const res=j.data||[];
    if(!res.length){ box.innerHTML=`<div class="muted">0件</div>`; return; }
    for(const r of res){
      const el=document.createElement("div"); el.className="card";
      el.innerHTML = `<div class="row"><b>${r.label}</b><span class="muted">avg ${r.avg_rt.toFixed?.(1) ?? r.avg_rt}s / n=${r.n}</span></div>`;
      box.append(el);
    }
  }catch(e){ box.innerHTML=`<div class="muted">未対応またはエラー：${e.message}</div>`; }
}
$id("btnLoadRT").onclick = loadRT;

async function loadImpressions(){
  const box=$id("impBox"); clearBox(box);
  try{
    const days = Number($id("days_imp").value||7);
    const grain = $id("grain").value;
    const j = await callAdmin2(`?view=impressions&days=${days}&grain=${grain}`);
    const res = j.data||[];
    if(!res.length){ box.innerHTML=`<div class="muted">0件</div>`; return; }
    for(const r of res){
      const el=document.createElement("div"); el.className="card";
      el.innerHTML = `<div class="row"><b>${r.bucket}</b><span class="muted">${r.count} 件</span></div>`;
      box.append(el);
    }
  }catch(e){ box.innerHTML=`<div class="muted">未対応またはエラー：${e.message}</div>`; }
}
$id("btnLoadImp").onclick = loadImpressions;

async function loadVBD(){
  const box=$id("vbdBox"); clearBox(box);
  try{
    const days = Number($id("days_vbd").value||7);
    const limit= Number($id("vbd_limit").value||100);
    const j = await callAdmin2(`?view=votes_deck&days=${days}&limit=${limit}`);
    const res = j.data||[];
    if(!res.length){ box.innerHTML=`<div class="muted">0件</div>`; return; }
    for(const r of res){
      const el=document.createElement("div"); el.className="card";
      const name = r.deck_name || r.source_url || r.deck_id;
      el.innerHTML = `<div class="row"><a class="link" target="_blank" href="${r.source_url}">${name}</a><span class="pill mono">ID ${r.deck_id}</span><span class="muted">votes ${r.votes}</span></div>`;
      box.append(el);
    }
  }catch(e){ box.innerHTML=`<div class="muted">未対応またはエラー：${e.message}</div>`; }
}
$id("btnLoadVBD").onclick = loadVBD;

/* ====== ブロック ====== */
async function loadBlocklist(){
  const box=$id("blocklist"); clearBox(box);
  try{
    const j = await callAdmin2(`?view=blocklist`);
    const ips = j.ips||[], sids=j.sessions||[];
    const ipCard=document.createElement("div"); ipCard.className="card";
    ipCard.innerHTML="<h3>IP</h3>";
    const ipList=document.createElement("div"); ipList.className="grid";
    for(const r of ips){
      const row=document.createElement("div"); row.className="row";
      row.innerHTML=`<span class="mono">${r.ip}</span>`;
      const un=document.createElement("button"); un.textContent="解除"; un.onclick=()=> postUnblockIp(r.ip,row);
      row.append(un); ipList.append(row);
    }
    const addRow=document.createElement("div"); addRow.className="row";
    const ipIn=document.createElement("input"); ipIn.placeholder="IP";
    const add=document.createElement("button"); add.textContent="IPブロック"; add.onclick=()=> postBlockIp(ipIn.value, ipList);
    addRow.append(ipIn,add); ipCard.append(ipList,addRow);

    const sidCard=document.createElement("div"); sidCard.className="card";
    sidCard.innerHTML="<h3>Session</h3>";
    const sidList=document.createElement("div"); sidList.className="grid";
    for(const r of sids){
      const row=document.createElement("div"); row.className="row";
      row.innerHTML=`<span class="mono">${r.session_id}</span>`;
      const un=document.createElement("button"); un.textContent="解除"; un.onclick=()=> postUnblockSession(r.session_id,row);
      row.append(un); sidList.append(row);
    }
    const addRow2=document.createElement("div"); addRow2.className="row";
    const sidIn=document.createElement("input"); sidIn.placeholder="Session";
    const add2=document.createElement("button"); add2.textContent="Sessionブロック"; add2.onclick=()=> postBlockSession(sidIn.value, sidList);
    addRow2.append(sidIn,add2); sidCard.append(sidList,addRow2);

    box.append(ipCard,sidCard);
  }catch(e){ box.innerHTML=`<div class="muted">エラー：${e.message}</div>`; }
}
async function postBlockIp(ip, list){ if(!ip) return; try{ await callAdmin2("",{method:"POST",body:{action:"block_ip",ip}}); loadBlocklist(); }catch(e){ alert(e.message); } }
async function postUnblockIp(ip, row){ try{ await callAdmin2("",{method:"POST",body:{action:"unblock_ip",ip}}); row.remove(); }catch(e){ alert(e.message); } }
async function postBlockSession(session_id){ if(!session_id) return; try{ await callAdmin2("",{method:"POST",body:{action:"block_session",session_id}}); loadBlocklist(); }catch(e){ alert(e.message); } }
async function postUnblockSession(session_id, row){ try{ await callAdmin2("",{method:"POST",body:{action:"unblock_session",session_id}}); row.remove(); }catch(e){ alert(e.message); } }
$id("btnLoadBL").onclick = loadBlocklist;

/* ====== ユーザー上位 ====== */
async function loadReporters(){
  const box=$id("reporters"); clearBox(box);
  try{
    const days=Number($id("days_rep").value||7), limit=Number($id("limit_rep").value||100);
    const j=await callAdmin2(`?view=reporters&days=${days}&limit=${limit}`);
    const data=j.data||[];
    if(!data.length){ box.innerHTML=`<div class="muted">0件</div>`; return; }
    for(const r of data){
      const el=document.createElement("div"); el.className="card";
      el.innerHTML=`<div class="row"><span class="mono">${r.ip||"(no ip)"} / ${r.session_id||"(no session)"}</span><span class="muted">件数 ${r.count} / 最終 ${fmtDate(r.last)}</span></div>`;
      const btns=document.createElement("div"); btns.className="btns";
      if(r.ip){ const b=document.createElement("button"); b.textContent=r.blocked_ip?"IP解除":"IPブロック"; b.onclick=()=> (r.blocked_ip?postUnblockIp(r.ip,el):postBlockIp(r.ip,box)); btns.append(b); }
      if(r.session_id){ const b2=document.createElement("button"); b2.textContent=r.blocked_session?"Session解除":"Sessionブロック"; b2.onclick=()=> (r.blocked_session?postUnblockSession(r.session_id,el):postBlockSession(r.session_id)); btns.append(b2); }
      el.append(btns); box.append(el);
    }
  }catch(e){ box.innerHTML=`<div class="muted">エラー：${e.message}</div>`; }
}
$id("btnLoadRep").onclick = loadReporters;

async function loadRegistrants(){
  const box=$id("registrants"); clearBox(box);
  try{
    const days=Number($id("days_reg").value||7), limit=Number($id("limit_reg").value||100);
    const j=await callAdmin2(`?view=registrants&days=${days}&limit=${limit}`);
    const data=j.data||[];
    if(!data.length){ box.innerHTML=`<div class="muted">0件</div>`; return; }
    for(const r of data){
      const el=document.createElement("div"); el.className="card";
      el.innerHTML=`<div class="row"><span class="mono">${r.ip||"(no ip)"} / ${r.session_id||"(no session)"}</span><span class="muted">件数 ${r.count} / 最終 ${fmtDate(r.last)}</span></div>`;
      const btns=document.createElement("div"); btns.className="btns";
      if(r.ip){ const b=document.createElement("button"); b.textContent=r.blocked_ip?"IP解除":"IPブロック"; b.onclick=()=> (r.blocked_ip?postUnblockIp(r.ip,el):postBlockIp(r.ip,box)); btns.append(b); }
      if(r.session_id){ const b2=document.createElement("button"); b2.textContent=r.blocked_session?"Session解除":"Sessionブロック"; b2.onclick=()=> (r.blocked_session?postUnblockSession(r.session_id,el):postBlockSession(r.session_id)); btns.append(b2); }
      el.append(btns); box.append(el);
    }
  }catch(e){ box.innerHTML=`<div class="muted">エラー：${e.message}</div>`; }
}
$id("btnLoadReg").onclick = loadRegistrants;

/* ====== 復旧 ====== */
async function loadDeleted(){
  const box=$id("deletedList"); clearBox(box);
  try{
    const days=Number($id("days_del").value||30), limit=Number($id("limit_del").value||100);
    const j=await callAdmin2(`?view=deleted_list&days=${days}&limit=${limit}`);
    const data=j.data||[];
    if(!data.length){ box.innerHTML=`<div class="muted">0件</div>`; return; }
    for(const r of data){
      const el=document.createElement("div"); el.className="card";
      const a=document.createElement("a"); a.href=r.source_url; a.target="_blank"; a.className="link"; a.textContent=r.deck_name||r.source_url||r.deck_id||"(deleted)";
      const row1=document.createElement("div"); row1.className="row";
      row1.append(a); row1.insertAdjacentHTML("beforeend", `<span class="pill mono">deck ${r.deck_id||"-"}</span>`);
      const row2=document.createElement("div"); row2.className="row muted";
      row2.textContent=`削除: ${fmtDate(r.deleted_at)} / 理由: ${r.reason||"-"} / by ${r.deleted_by||"-"}`;
      const btn=document.createElement("button"); btn.textContent="復旧"; btn.className="ok";
      btn.onclick=async()=>{ try{ await callAdmin2("",{method:"POST",body:{action:"restore_deck", log_id:r.id}}); el.remove(); }catch(e){ alert("復旧失敗: "+e.message); } };
      el.append(row1,row2,btn); box.append(el);
    }
  }catch(e){ box.innerHTML=`<div class="muted">エラー：${e.message}</div>`; }
}
$id("btnLoadDel").onclick = loadDeleted;

/* 初期：設定だけ読み込む */
loadSettings();
</script>
</body>
</html>
