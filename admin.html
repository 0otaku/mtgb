<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>管理 | みんなでブラケット診断</title>
<meta name="robots" content="noindex, nofollow">
<style>
  :root{ --border:#e5e7eb; --muted:#64748b; --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626; }
  body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;padding:16px;background:#fff;color:#0f172a}
  h1{margin:0 0 12px;font-size:18px}
  h2{margin:18px 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,select,textarea{padding:8px 10px;border:1px solid var(--border);border-radius:8px;font:inherit}
  textarea{width:100%;min-height:120px;resize:vertical}
  button{cursor:pointer;background:#fff}
  .grid{display:grid;gap:10px}
  .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
  .muted{color:var(--muted);font-size:12px}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  .danger{background:var(--danger);color:#fff;border-color:var(--danger)}
  .warn{background:var(--warn);color:#111827;border-color:var(--warn)}
  .ok{background:var(--ok);color:#fff;border-color:var(--ok)}
  .link{color:#2563eb;text-decoration:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
  .section{margin-top:16px}
  details>summary{cursor:pointer;user-select:none}
  .close-btn{margin-left:auto}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3f4f6;border:1px solid var(--border)}
  .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .w120{width:120px}
  .w90{width:90px}
  .wide{min-width:320px}
</style>
<body>
  <div class="row">
    <h1>管理</h1>
    <label>Admin Token: <input id="token" class="wide" placeholder="保存されます"></label>
    <button id="showToken">表示</button>
  </div>

  <!-- ====== 設定 ====== -->
  <details class="section" open>
    <summary><h2>設定</h2></summary>

    <div class="row" style="align-items:flex-start">
      <label>通報しきい値 <input id="th" type="number" value="5" class="w90"></label>
      <button id="btnLoadSet">読み込み</button>
      <button id="btnSaveSet" class="ok">保存</button>
      <button class="close-btn" onclick="/* no-op */">閉じる</button>
    </div>
    <div class="muted">※ この件数以上の通報で該当デッキを自動削除します。</div>

    <!-- 拡張設定（XP / Mana） -->
    <div class="card" style="margin-top:10px">
      <div class="settings-grid">
        <div>
          <div class="row"><b>XP / レベル条件（JSON）</b><button id="xpClear">クリア</button></div>
          <textarea id="xpJson" placeholder='{"levels":[10,30,70,150]}'></textarea>
        </div>
        <div>
          <div class="row"><b>マナ付与ルール（JSON）</b><button id="manaClear">クリア</button></div>
          <textarea id="manaJson" placeholder='{"doubleSeconds":[11,22]}'></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnLoadExt">拡張設定 読み込み</button>
        <button id="btnSaveExt" class="ok">拡張設定 保存</button>
        <span class="muted">※ app_settings に JSON で保存/読込します</span>
      </div>
    </div>
  </details>

  <!-- ====== デッキ検索 / 直操作（簡易） ====== -->
  <details class="section" open>
    <summary><h2>デッキ検索 / 直接操作</h2></summary>
    <div class="row">
      <input id="qDeck" class="wide" placeholder="URL または 数字ID">
      <button id="btnQDeck">検索</button>
      <button class="close-btn" onclick="/* no-op */">閉じる</button>
    </div>
    <div id="qDeckBox" class="grid"></div>
  </details>

  <!-- ====== 通報一覧 ====== -->
  <details class="section" open>
    <summary><h2>通報一覧</h2></summary>
    <div class="row">
      <label>検索 <input id="q" placeholder="URL/名前/ID"></label>
      <label>最小通報数 <input id="min" type="number" value="1" class="w90"></label>
      <label>件数 <input id="limit" type="number" value="50" class="w90"></label>
      <label>From <input id="from" type="date"></label>
      <label>To <input id="to" type="date"></label>
      <button id="btnLoadReports">読み込み</button>
      <button class="close-btn" onclick="document.getElementById('reportList').innerHTML=''">閉じる</button>
    </div>
    <div id="reportList" class="grid"></div>
  </details>

  <!-- ====== アナリティクス ====== -->
  <details class="section" open>
    <summary><h2>アナリティクス</h2></summary>

    <div class="card">
      <div class="row">
        <label>過去 <input id="days_sum" type="number" value="7" class="w90"></label> 日
        <button id="btnLoadSummary">サマリー 読み込み</button>
        <button class="close-btn" onclick="document.getElementById('summaryBox').innerHTML=''">閉じる</button>
      </div>
      <div id="summaryBox" class="grid"></div>
    </div>

    <div class="card">
      <div class="row">
        <label>過去 <input id="days_rt" type="number" value="7" class="w90"></label> 日
        <button id="btnLoadRT">反応速度 読み込み</button>
        <button class="close-btn" onclick="document.getElementById('rtBox').innerHTML=''">閉じる</button>
      </div>
      <div id="rtBox" class="grid"></div>
    </div>

    <div class="card">
      <div class="row">
        <label>過去 <input id="days_imp" type="number" value="7" class="w90"></label> 日
        <label><select id="grain"><option value="hour">時間</option><option value="day">日</option></select></label>
        <button id="btnLoadImp">アクセス数 読み込み</button>
        <button class="close-btn" onclick="document.getElementById('impBox').innerHTML=''">閉じる</button>
      </div>
      <div id="impBox" class="grid"></div>
    </div>

    <div class="card">
      <div class="row">
        <label>過去 <input id="days_vbd" type="number" value="7" class="w90"></label> 日
        <label>件数 <input id="vbd_limit" type="number" value="100" class="w90"></label>
        <button id="btnLoadVBD">人気デッキ 読み込み</button>
        <button class="close-btn" onclick="document.getElementById('vbdBox').innerHTML=''">閉じる</button>
      </div>
      <div id="vbdBox" class="grid"></div>
    </div>
  </details>

  <!-- ====== ブロック一覧 ====== -->
  <details class="section" open>
    <summary><h2>ブロック一覧</h2></summary>
    <div class="row">
      <button id="btnLoadBL">読み込み</button>
      <button class="close-btn" onclick="document.getElementById('blocklist').innerHTML=''">閉じる</button>
    </div>
    <div class="grid" id="blocklist"></div>
  </details>

  <!-- ====== 復旧一覧 ====== -->
  <details class="section" open>
    <summary><h2>復旧一覧（自動/手動削除ログ）</h2></summary>
    <div class="row">
      <label>過去 <input id="days_del" type="number" value="30" class="w90"></label> 日間
      <label>件数 <input id="limit_del" type="number" value="100" class="w90"></label>
      <button id="btnLoadDel">読み込み</button>
      <button class="close-btn" onclick="document.getElementById('deletedList').innerHTML=''">閉じる</button>
    </div>
    <div id="deletedList" class="grid"></div>
  </details>

<script>
/* ====== 接続設定 ====== */
const ADMIN2_URL = "https://onzljxnqlrohkzsfxqbh.supabase.co/functions/v1/admin2"; // ←自環境
const $id = (id)=>document.getElementById(id);
$id("token").value = localStorage.getItem("admin_token") || "";
$id("token").addEventListener("input",()=>localStorage.setItem("admin_token",$id("token").value));
$id("showToken").onclick = () => alert($id("token").value || "(empty)");

/* ====== 共通 ====== */
function clearBox(node){ node.innerHTML=""; }
function fmtDate(s){ try{ return new Date(s).toLocaleString('ja-JP',{ timeZone:'Asia/Tokyo', hour12:false }); }catch{ return s; } }
function mask(v){ if(!v) return "(none)"; const s=String(v); return s.length<=6 ? s : s.slice(0,3)+"…"+s.slice(-3); }

/* API 呼び出し */
async function callAdmin2(query, opt={}){
  const token = $id("token").value.trim();
  if(!token){ alert("Admin Token を入力してください"); throw new Error("no token"); }
  const url = (query.startsWith("http")?query:`${ADMIN2_URL}${query}`);
  const init = { method: opt.method||"GET", headers: { "x-admin-token": token, "content-type":"application/json" } };
  if(opt.body) init.body = JSON.stringify(opt.body);
  const res = await fetch(url, init);
  const txt = await res.text();
  let json;
  try{ json = JSON.parse(txt); }catch{ json = { ok:false, error:txt } }
  if(!res.ok || json?.ok===false) throw new Error(json?.error||res.statusText);
  return json;
}

/* ====== 設定 読み書き ====== */
async function loadSettings(){
  try{
    const j = await callAdmin2(`?view=settings`);
    $id("th").value = j.data?.report_delete_threshold?.value ?? 5;
    // 拡張設定 もついでに流し込み
    const xp = j.data?.xp_rules ?? null;
    const mana = j.data?.mana_rules ?? null;
    if (xp) $id("xpJson").value = JSON.stringify(xp, null, 2);
    if (mana) $id("manaJson").value = JSON.stringify(mana, null, 2);
  }catch(e){ alert("設定取得エラー: "+e.message); }
}
async function saveSettings(){
  try{
    const n = Number($id("th").value);
    await callAdmin2("",{ method:"POST", body:{ action:"set_settings", report_delete_threshold:n }});
    alert("保存しました");
  }catch(e){ alert("保存エラー: "+e.message); }
}
$id("btnLoadSet").onclick = loadSettings;
$id("btnSaveSet").onclick = saveSettings;

// 拡張設定
$id("xpClear").onclick = ()=>{ $id("xpJson").value=""; };
$id("manaClear").onclick = ()=>{ $id("manaJson").value=""; };
$id("btnLoadExt").onclick = async ()=>{
  try{
    const j = await callAdmin2(`?view=settings`);
    $id("xpJson").value = j.data?.xp_rules ? JSON.stringify(j.data.xp_rules, null, 2) : "";
    $id("manaJson").value = j.data?.mana_rules ? JSON.stringify(j.data.mana_rules, null, 2) : "";
  }catch(e){ alert("拡張設定取得エラー: "+e.message); }
};
$id("btnSaveExt").onclick = async ()=>{
  try{
    const xpRaw = $id("xpJson").value.trim();
    const manaRaw = $id("manaJson").value.trim();
    const payload = { action:"set_settings" };
    if (xpRaw) payload["xp_rules"] = JSON.parse(xpRaw);
    if (manaRaw) payload["mana_rules"] = JSON.parse(manaRaw);
    await callAdmin2("",{ method:"POST", body:payload });
    alert("拡張設定を保存しました");
  }catch(e){ alert("拡張設定の保存に失敗: "+e.message); }
};

/* ====== デッキ検索（簡易） ====== */
$id("btnQDeck").onclick = async ()=>{
  const box = $id("qDeckBox"); clearBox(box);
  const q = $id("qDeck").value.trim();
  const qs = new URLSearchParams({ view:"decks", limit:"50" }); if(q) qs.set("q", q);
  try{
    const j = await callAdmin2(`?${qs.toString()}`);
    const data = j.data||[];
    if(!data.length){ box.innerHTML = `<div class="muted">0件</div>`; return; }
    for(const d of data){
      const el = document.createElement("div"); el.className="card";
      const a = document.createElement("a"); a.href=d.source_url; a.target="_blank"; a.className="link";
      a.textContent = d.deck_name || d.source_url || d.id;
      el.append(a);
      const meta = document.createElement("div"); meta.className="muted";
      meta.textContent = `ID ${d.id} / 登録 ${fmtDate(d.created_at)} / 通報 ${d.report_count}`;
      el.append(meta);
      box.append(el);
    }
  }catch(e){ box.innerHTML = `<div class="muted">エラー：${e.message}</div>`; }
};

/* ====== 通報一覧（BAN追加） ====== */
async function loadReports(){
  const box = $id("reportList");
  clearBox(box);
  try{
    const q = $id("q").value.trim();
    const min = Number($id("min").value||1);
    const limit = Number($id("limit").value||50);
    const from = $id("from").value || "";
    const to   = $id("to").value   || "";
    const qs = new URLSearchParams({ view:"reports", min, limit });
    if(q) qs.set("q", q);
    if(from) qs.set("from", from);
    if(to) qs.set("to", to);
    const j = await callAdmin2(`?${qs.toString()}`);
    const data = j.data||[];
    if(!data.length){ box.innerHTML = `<div class="muted">0件</div>`; return; }

    for(const r of data){
      const div = document.createElement("div"); div.className="card";
      const a = document.createElement("a"); a.href=r.deck_source_url; a.target="_blank"; a.className="link";
      a.textContent = r.deck_name || r.deck_source_url || r.deck_id;
      const idpill = `<span class="pill mono">ID ${r.deck_id}</span>`;
      const row1 = document.createElement("div"); row1.className="row";
      row1.append(a); row1.insertAdjacentHTML("beforeend", idpill);

      const row2 = document.createElement("div"); row2.className="row muted";
      const author = `投稿者 IP:${mask(r.author_ip)} / Session:${mask(r.author_session)}`;
      row2.textContent = `通報 ${r.report_count} / 最終 ${fmtDate(r.latest_reported_at)} / ${author}`;

      const btns = document.createElement("div"); btns.className="btns";
      const btnDel = document.createElement("button"); btnDel.className="danger"; btnDel.textContent="削除";
      btnDel.onclick = async ()=>{
        if(!confirm("このデッキを削除しますか？")) return;
        try{ await callAdmin2("",{method:"POST", body:{action:"delete_deck", deck_id:r.deck_id}}); div.remove(); }
        catch(e){ alert("削除失敗: "+e.message); }
      };
      const btnClr = document.createElement("button"); btnClr.className="warn"; btnClr.textContent="通報クリア";
      btnClr.onclick = async ()=>{
        try{ await callAdmin2("",{method:"POST", body:{action:"clear_reports", deck_id:r.deck_id}}); alert("クリアしました"); }
        catch(e){ alert("失敗: "+e.message); }
      };

      // ★ 投稿者 BAN（IP / Session）
      const banIp = document.createElement("button");
      banIp.textContent = r.author_ip ? `投稿者BAN(IP:${mask(r.author_ip)})` : "投稿者BAN(IPなし)";
      if (r.author_ip) {
        banIp.onclick = async ()=>{
          if(!confirm(`IP をBANしますか？\n${r.author_ip}`)) return;
          try{ await callAdmin2("",{method:"POST", body:{action:"block_ip", ip:r.author_ip}}); alert("IPをBANしました"); }
          catch(e){ alert("BAN失敗: "+e.message); }
        };
      } else { banIp.disabled = true; }

      const banSid = document.createElement("button");
      banSid.textContent = r.author_session ? `投稿者BAN(Session:${mask(r.author_session)})` : "投稿者BAN(Sessionなし)";
      if (r.author_session) {
        banSid.onclick = async ()=>{
          if(!confirm(`Session をBANしますか？\n${r.author_session}`)) return;
          try{ await callAdmin2("",{method:"POST", body:{action:"block_session", session_id:r.author_session}}); alert("SessionをBANしました"); }
          catch(e){ alert("BAN失敗: "+e.message); }
        };
      } else { banSid.disabled = true; }

      // まとめてBAN（authorが取れない場合は自動で無効）
      const banBoth = document.createElement("button");
      banBoth.textContent = "投稿者BAN(一括)";
      if (r.author_ip || r.author_session) {
        banBoth.className="ok";
        banBoth.onclick = async ()=>{
          if(!confirm("投稿者をBANしますか？(IP/Session)")) return;
          try{ await callAdmin2("",{method:"POST", body:{action:"block_author_of_deck", deck_id:r.deck_id}}); alert("投稿者をBANしました"); }
          catch(e){ alert("BAN失敗: "+e.message); }
        };
      } else { banBoth.disabled = true; }

      btns.append(btnDel, btnClr, banIp, banSid, banBoth);
      div.append(row1,row2,btns);
      box.append(div);
    }
  }catch(e){ box.innerHTML = `<div class="muted">未対応またはエラー：${e.message}</div>`; }
}
$id("btnLoadReports").onclick = loadReports;

/* ====== アナリティクス ====== */
$id("btnLoadSummary").onclick = async ()=>{
  const box=$id("summaryBox"); clearBox(box);
  try{
    const days = Number($id("days_sum").value||7);
    const j = await callAdmin2(`?view=analytics_summary&days=${days}`);
    const r = j.data;
    const el = document.createElement("div"); el.className="card";
    el.innerHTML = `
      <div class="row"><b>過去 ${days} 日のサマリー</b></div>
      <div class="muted">
        平均RT: ${r.avg_rt!=null? r.avg_rt.toFixed(2):"-"}s / p50: ${r.p50!=null? r.p50.toFixed(2):"-"}s / n=${r.n}<br>
        PV: ${r.pv ?? 0} / UU(投票者): ${r.uu_voters ?? 0}
      </div>`;
    box.append(el);
  }catch(e){ box.innerHTML=`<div class="muted">エラー：${e.message}</div>`; }
};

$id("btnLoadRT").onclick = async ()=>{
  const box=$id("rtBox"); clearBox(box);
  try{
    const days = Number($id("days_rt").value||7);
    const j = await callAdmin2(`?view=rt_global&days=${days}`);
    const res=j.data||[];
    if(!res.length){ box.innerHTML=`<div class="muted">0件</div>`; return; }
    for(const r of res){
      const el=document.createElement("div"); el.className="card";
      const avg = (r.avg_rt ?? r.avg ?? 0);
      const p50 = (r.p50 ?? null);
      el.innerHTML = `<div class="row"><b>${r.label||("過去"+days+"日")}</b><span class="muted">avg ${Number(avg).toFixed(2)}s / p50 ${p50!=null?Number(p50).toFixed(2):"-"}s / n=${r.n??"-"}</span></div>`;
      box.append(el);
    }
  }catch(e){ box.innerHTML=`<div class="muted">未対応またはエラー：${e.message}</div>`; }
};

$id("btnLoadImp").onclick = async ()=>{
  const box=$id("impBox"); clearBox(box);
  try{
    const days = Number($id("days_imp").value||7);
    const grain = $id("grain").value;
    const j = await callAdmin2(`?view=impressions&days=${days}&grain=${grain}`);
    const res = j.data||[];
    if(!res.length){ box.innerHTML=`<div class="muted">0件</div>`; return; }
    for(const r of res){
      const el=document.createElement("div"); el.className="card";
      el.innerHTML = `<div class="row"><b>${r.bucket}</b><span class="muted">${r.count} 件</span></div>`;
      box.append(el);
    }
  }catch(e){ box.innerHTML=`<div class="muted">未対応またはエラー：${e.message}</div>`; }
};

$id("btnLoadVBD").onclick = async ()=>{
  const box=$id("vbdBox"); clearBox(box);
  try{
    const days = Number($id("days_vbd").value||7);
    const limit= Number($id("vbd_limit").value||100);
    const j = await callAdmin2(`?view=votes_deck&days=${days}&limit=${limit}`);
    const res = j.data||[];
    if(!res.length){ box.innerHTML=`<div class="muted">0件</div>`; return; }
    for(const r of res){
      const el=document.createElement("div"); el.className="card";
      const name = r.deck_name || r.source_url || r.deck_id;
      el.innerHTML = `<div class="row"><a class="link" target="_blank" href="${r.source_url}">${name}</a><span class="pill mono">ID ${r.deck_id}</span><span class="muted">votes ${r.votes}</span></div>`;
      box.append(el);
    }
  }catch(e){ box.innerHTML=`<div class="muted">未対応またはエラー：${e.message}</div>`; }
};

/* ====== ブロック一覧 ====== */
async function loadBlocklist(){
  const box=$id("blocklist"); clearBox(box);
  try{
    const j = await callAdmin2(`?view=blocklist`);
    const ips = j.ips||[], sids=j.sessions||[];
    const ipCard=document.createElement("div"); ipCard.className="card"; ipCard.innerHTML="<h3>IP</h3>";
    const ipList=document.createElement("div"); ipList.className="grid";
    for(const r of ips){
      const row=document.createElement("div"); row.className="row";
      row.innerHTML=`<span class="mono">${r.ip}</span>`;
      const un=document.createElement("button"); un.textContent="解除";
      un.onclick=async()=>{ try{ await callAdmin2("",{method:"POST",body:{action:"unblock_ip",ip:r.ip}}); row.remove(); }catch(e){ alert(e.message); } };
      row.append(un); ipList.append(row);
    }
    const addRow=document.createElement("div"); addRow.className="row";
    const ipIn=document.createElement("input"); ipIn.placeholder="IP";
    const add=document.createElement("button"); add.textContent="IPブロック";
    add.onclick=async()=>{ try{ await callAdmin2("",{method:"POST",body:{action:"block_ip",ip:ipIn.value}}); loadBlocklist(); }catch(e){ alert(e.message); } };
    addRow.append(ipIn,add); ipCard.append(ipList,addRow);

    const sidCard=document.createElement("div"); sidCard.className="card"; sidCard.innerHTML="<h3>Session</h3>";
    const sidList=document.createElement("div"); sidList.className="grid";
    for(const r of sids){
      const row=document.createElement("div"); row.className="row";
      row.innerHTML=`<span class="mono">${r.session_id}</span>`;
      const un=document.createElement("button"); un.textContent="解除";
      un.onclick=async()=>{ try{ await callAdmin2("",{method:"POST",body:{action:"unblock_session",session_id:r.session_id}}); row.remove(); }catch(e){ alert(e.message); } };
      row.append(un); sidList.append(row);
    }
    const addRow2=document.createElement("div"); addRow2.className="row";
    const sidIn=document.createElement("input"); sidIn.placeholder="Session";
    const add2=document.createElement("button"); add2.textContent="Sessionブロック";
    add2.onclick=async()=>{ try{ await callAdmin2("",{method:"POST",body:{action:"block_session",session_id:sidIn.value}}); loadBlocklist(); }catch(e){ alert(e.message); } };
    addRow2.append(sidIn,add2); sidCard.append(sidList,addRow2);

    box.append(ipCard,sidCard);
  }catch(e){ box.innerHTML=`<div class="muted">エラー：${e.message}</div>`; }
}
$id("btnLoadBL").onclick = loadBlocklist;

/* ====== 復旧 ====== */
$id("btnLoadDel").onclick = async ()=>{
  const box=$id("deletedList"); clearBox(box);
  try{
    const days=Number($id("days_del").value||30), limit=Number($id("limit_del").value||100);
    const j=await callAdmin2(`?view=deleted_list&days=${days}&limit=${limit}`);
    const data=j.data||[];
    if(!data.length){ box.innerHTML=`<div class="muted">0件</div>`; return; }
    for(const r of data){
      const el=document.createElement("div"); el.className="card";
      const a=document.createElement("a"); a.href=r.source_url; a.target="_blank"; a.className="link"; a.textContent=r.deck_name||r.source_url||r.deck_id||"(deleted)";
      const row1=document.createElement("div"); row1.className="row";
      row1.append(a); row1.insertAdjacentHTML("beforeend", `<span class="pill mono">deck ${r.deck_id||"-"}</span>`);
      const row2=document.createElement("div"); row2.className="row muted";
      row2.textContent=`削除: ${fmtDate(r.deleted_at)} / 理由: ${r.reason||"-"} / by ${r.deleted_by||"-"}`;
      const btn=document.createElement("button"); btn.textContent="復旧"; btn.className="ok";
      btn.onclick=async()=>{ try{ await callAdmin2("",{method:"POST",body:{action:"restore_deck", log_id:r.id}}); el.remove(); }catch(e){ alert("復旧失敗: "+e.message); } };
      el.append(row1,row2,btn); box.append(el);
    }
  }catch(e){ box.innerHTML=`<div class="muted">エラー：${e.message}</div>`; }
};

/* 初期：設定だけ読み込む */
loadSettings();
</script>
</body>
</html>
